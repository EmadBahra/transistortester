\chapter{Hardware}

\section{Die Schaltung des TransistorTesters}
\label{sec:hardware}
Die Schaltung des TransistorTesters in Abbildung~\ref{fig:ttester} basiert auf der Schaltung von
Markus F., die er in Abb. 1 des AVR-Transistortester Reports \cite{Frejek} veröffentlicht hat.
Geänderte oder verschobene Bauteile sind mit \textcolor{green}{grüner Farbe} markiert, optionale Teile sind
mit \textcolor{red}{roter Farbe} gekennzeichnet.

Einige Änderungen wurden gemacht, weil die Strom-Abschaltung in einigen Nachbauten Probleme
bereitet hatte.
Deshalb ist der Widerstand R7 auf \(3.3k\Omega\) reduziert. 
Der Kondensator C2 ist auf 10nF verkleinert und der Widerstand R8 ist verschoben, so dass der
Ausgang PD6 nicht versucht, den C2 Kondensator direkt zu laden.
Zusätzliche Abblock-Kondensatoren wurden hinzugefügt und sollten nahe den Versorgungs-Anschlüssen
des ATmega und nahe bei dem Spannungsregler plaziert werden.

Weil der PD7-Eingang und der PC6-Anschluss (RESET) die einzigen Anschlüsse sind, wo
,,pull-up'' Widerstände gebraucht werden, wurde ein zusätzlicher \(27k\Omega\) Widerstand am PD7 (Pin 13) vorgesehen.
Mit dieser Änderung können die internen ,,pull-up'' Widerstände des ATmega abgeschaltet werden.

Ein Quarz mit seinen 22pF Kondensatoren wurde zusätzlich vorgesehen.
Ein Quarz hat Vorteile für die Kapazitätsmessung wegen der genaueren Zeitmessung.

Die neue Software kann den Spannungsbereich für den ADC umschalten. Die Um\-schalt-Ge\-schwin\-dig\-keit
wird durch den externen Kondensator C1 am AREF-Pin (21) des ATmega reduziert.
Um die Messung nicht langsamer als notwendig machen zu müssen, sollte der Kondensator auf
1nF reduziert werden. Ein Entfernen des Kondensators ist ebenfalls möglich.
Zum Anpassen der Software an die jeweilige Schaltung schauen Sie bitte in dem
Kon\-fi\-gura\-tions-Kapitel~\ref{sec:config} nach. 

Einige unterschiedliche Kombinationen von R11 / R12 zirkulieren im Internet.
Ich habe die Software an den Original-Entwurf von Markus F.~\cite{Frejek} mit \(10k\Omega\) und \(3,3k\Omega\) angepasst.

Die zusätzliche 2,5V Präzisions-Spannungsreferenz, die an Pin PC4 (ADC4) angeschlossen ist,
wird für die Überprüfung und Kalibration der VCC Versorgungsspannung benutzt, ist aber nicht
erforderlich.
Ein zusätzlicher ISP-Anschluss wurde hinzugefügt, um leichter neue Software-Versionen
laden zu können.

\begin{figure}[H]
\centering
\includegraphics[width=18cm]{../FIG/ttester.eps}
\caption{Neue TransistorTester-Schaltung}
\label{fig:ttester}
\end{figure}

Um einen einfacheren Anschluss des Displays an den ATmega auf Streifenleiterplatinen zu erreichen,
kann die Software auch eine andere Port-D-Belegung berücksichtigen.
Die folgende Tabelle \ref{tab:grid-change} zeigt die Änderungen der Pinbelegungen.

\begin{table}[H]
  \begin{center}
    \begin{tabular}{| c | c | c |}
    \hline
       Signal & Schaltbild & Streifenleiter\\
    \hline
    Tastensignal  &  PD7   &  PD0 \\
    LCD-RS    &  PD4      & PD7 \\
    LCD-E     &  PD5   & PD5 \\
    LCD-D4    &  PD0   & PD4 \\
    LCD-D5    &  PD1   & PD3 \\
    LCD-D6    &  PD2   & PD2 \\
    LCD-D7    &  PD3   & PD1 \\
    \hline
    \end{tabular}
  \end{center}
  \caption{Änderungen für Streifenleiter-Platine}
  \label{tab:grid-change}
\end{table}

Zum besseren Schutz der ATmega-Eingänge kann eine Erweiterung mit einem Relais nach Schaltbild~\ref{fig:relay_addon}
angeschlossen werden. Die Ruhekontakte des Relais schützen den ATmega im spannungslosen Zustand.
Die Konkakte werden von der Software nur für die Messung freigegeben.

\begin{figure}[H]
\centering
\includegraphics[width=7cm]{../FIG/relay_addon.eps}
\caption{Zusätzlicher Schutz der ATmega Eingänge}
\label{fig:relay_addon}
\end{figure}

\section{Hinweise für den Aufbau des TransistorTesters}
Jede LCD-Anzeige-Einheit mit mindestens 2x16 Zeichen und einem HD44780-kompatiblen Kontroller kann mit
dem TransistorTester benutzt werden.
Man sollte auf den Strombedarf der Hintergrundbeleuchtung achten, einige Anzeigen benötigen
mehr Strom als andere.
Ich habe OLED Anzeigen ausprobiert, aber diese Anzeigen haben teilweise die Messung des
ATmega beeinflusst und werden nicht empfohlen. Auch das Laden der Spezialzeichen für die 
Widerstandsdarstellung hat mit OLED's Schwierigkeiten ergeben.

Die Widerstände R1 bis R6 sind kritisch für die Messungen und diese \(680\Omega\) und
\(470k\Omega\) Widerstände sollten Messwiderstände sein (Toleranz von 0,1\%), um 
die volle Genauigkeit zu erreichen.
Man sollte Präzisions-Sockel für den ATmega Mikrocontroller verwenden um
die Austauschbarkeit des Mikrocontrollers sicherzustellen.
Es kann ein ATmega8, ATmega168 und ATmega328 Mikrocontroller verwendet werden.
Empfohlen werden ATmega168 oder ATmega328, wenn man alle Funktionen nutzen möchte.

Jedenfalls sollte man zuerst alle Bauteile ohne den Mikrocontroller bestücken.
Es wird als IC2 ein moderner ,,low voltage drop'' Spannungsregler wie MCP1702-5002 empfohlen, weil
dieser nur \(2\mu A\) Ruhestrom benötigt und auch noch 5V liefern kann, 
 wenn die Eingangsspannung nur 5,4V beträgt.
Aber dieser Regler ist leider nicht Pin-kompatibel zum bekannteren 78L05 Regler im TO-92 Gehäuse!

Nachdem alle benötigten Bauteile bestückt sind, sollte zuerst die Batterie
oder das Netzteil angeschlossen werden. Das LCD sollte dabei nicht angeschlossen sein, und der Mikrocontroller sich noch nicht im Sockel befinden.
Man sollte die Betriebsspannung des Mikrocontrollers und der LCD-Anzeige
überprüfen während der Start-Taster gedrückt wird.
Die Betriebsspannung sollte verschwinden, wenn man den Start-Taster loslässt.
Wenn die Betriebsspannung die richtige Polarität und Grösse hatte,
sollte man die Strom-Versorgung entfernen und den Mikrocontroller 
richtig herum einstecken. Sind Sie bitte vorsichtig und stellen Sie sicher,
dass alle Pinne des Mikrocontrollers im Sockel stecken.
Danach können Sie das LCD anschliessen. Prüfen Sie, dass die GND- und VCC-Anschlüsse des LCD richtig mit der Baugruppe verbunden sind.

Wenn Sie sicher sind, dass alles richtig angeschlossen ist, schliessen Sie
die Spannungsversorgung wieder an.
Wenn Sie den ATmega schon programmiert haben, können Sie den Start-Taster
drücken.
Durch das Drücken des Start-Tasters sollte die Hintergrundbeleuchtung
der LCD-Anzeige angehen.
Wenn Sie den Taster loslassen, sollte die LED auf der Platine schwach leuchten.
Beachte, dass die Software für den Mikrocontroller für den richtigen
Prozessor-Typ übersetzt sein muss. Ein Programm für den ATmega8 läuft
nicht auf einem ATmega168!

\section{Programmierung des Mikrocontrollers}
Ich gebe die Software für den Mikrocontroller in Quelltext heraus.
Die Entwicklung wurde mit dem Linux Betriebssystem (Ubuntu) gemacht
und wird gesteuert mit einer Makefile.
Die Makefile stellt sicher, dass die Software entsprechend der vorher in der Makefile 
eingestellten Optionen übersetzt wird. Schauen Sie bitte in die LiesMich.txt Datei
im Verzeichnis trunk/default und in das Konfigurations-Kapitel~\ref{sec:config}.
Das Ergebnis der Übersetzung hat die Dateierweiterung .hex und .eep.
Üblicherweise heißen die Dateien TransistorTester.hex und TransistorTester.eep .
Die .hex Datei enthält die Daten für den Programmspeicher (Flash) des ATmega-Prozessors.
Die .eep Datei enthält die Daten für den EEprom-Speicher des ATmega.
Beide Dateien müssen in den richtigen Speicher geladen werden.

Zusätzlich muss der ATmega mit den ,,fuses'' richtig konfiguriert werden.
Wenn Sie meine Makefile zusammen mit dem Programm avrdude \cite{avrdude} benutzen, brauchen Sie
keine genaue Kenntnis über die Einzelheiten der fuses.
Sie brauchen nur ,,make fuses'' aufrufen, wenn Sie keinen Quarz benutzen oder Sie
müssen ,,make fuses-crystal'' aufrufen, wenn Sie einen 8MHz Quarz auf der Baugruppe installiert haben.
Bei der ATmega168 Serie der Mikrocontroller können Sie alternativ auch
,,make fuses-crystal-lp'' aufrufen für den low power Quarz Betrieb.
Benutzen Sie niemals die Quarz-Variante, wenn Sie keinen 8MHz Quarz installiert haben.
Wenn Sie sich nicht sicher mit den fuses sind, lassen Sie diese erst einmal wie
vom Werk gesetzt und bringen Sie den Tester in diesem Zustand zum Laufen.
Es kann sein, dass das Programm zu langsam läuft, wenn Sie die für den 8MHz Betrieb 
erzeugten Programmdaten benutzen, aber das kann man später korrigieren!
Aber falsch gesetzte fuses können die spätere ISP-Programmierung verhindern.
Wenn Sie unter dem Windows Betriebssystem arbeiten, ist der leichteste Weg zum
richtig programmierten ATmega zu kommen, die Benutzung der WinAVR Paketes \cite{winavr1},\cite{winavr2}.
Mit meinem Patch \cite{winavr3} können Sie auch die Fuses mit der Makefile setzen.
Natürlich muß das avrdude Programm Ihren Programmer unterstützen und die Konfiguration muß in
der Makefile richtig angepaßt sein.

\section{Fehlersuche}
Bei den meisten Problemen werden Sie den Text auf dem LCD-Display vermissen.
Zuerst sollten Sie prüfen, ob die LED auf der Platine schwach leuchtet, wenn Sie den Start-Taster
loslassen.
\begin{description}

\item[Gerät schaltet nicht ein]  
Wenn die LED nicht leuchtet, aber die VCC-Spannung den richtigen Wert hat, wenn
man den Start-Taster gedückt hält, schaltet der Mikrocontroller nicht richtig ein.
Der Mikrocontroller sollte die Spannung behalten indem der Ausgang PD6 auf 5V
geschaltet wird, was üblicherweise als eine der ersten Aktionen getan wird.
Wenn man die Start-Taste gedrückt hält, bleibt die Spannung ohnehin eingeschaltet.
So können Sie mit gedrücktem Taster den Wert der VCC-Spannung und zusätzlich den Spannungswert am
Ausgang PD6 prüfen.
Wenn die VCC-Spannung den richtigen Wert (5V) hat, aber die Spannung am Ausgang
PD6 unter 4V ist, startet der Mikrocontroller nicht richtig.
Für diesen Fall sollten Sie prüfen, ob die Programmdaten für den Flashspeicher
für den richtigen Prozessor-Typ ist und ob der Prozessor richtig konfiguriert ist (fuses).
Wenn der ATmega den Ausgang PD6 auf 5V schaltet und die Betriebsspannung 
trotzdem nicht eingeschaltet bleibt, wenn man den Start-Taster loslässt, ist der
Grund schwieriger zu finden.
Zuerst kann man die LED kurzschliessen und es noch einmal versuchen.
Wenn der Tester jetzt startet, ist die LED möglicherweise falsch herum eingebaut.
Wenn das nicht die Ursache ist, könnte der Grund ein unzureichender Stromverstärkungs-Faktor
des Transistors T3 (BC557C) sein.
Der Strom in die Basis von T3 ist niedriger, wenn der Mikrocontroller mit der LED einschaltet
wie im ,,Taster gedrückt''-Zustand.

\item[Nichts ist lesbar auf der LCD-Anzeige] 
Prüfen Sie die Spannung am Kontrast-Pin der LCD-Anzeige (Pin 3).
Stellen Sie mit dem Trimmer den Wert auf einen im Datenblatt angegebenen Wert und optimieren Sie
durch Sichtkontrolle.
Wenn Sie ein Hochtemperatur-Display haben, brauchen Sie eine negative Kontrast-Spannung für
den Betrieb.
In diesem Fall kann man den ICL~7660 Baustein zum Erzeugen der negativen Spannung aus der
positiven 5V verwenden.

Wenn keine Anzeige auf dem LCD erkannt wird und wenn die Hintergrundbeleuchtung an ist,
sollten Sie die Spannungsversorgung trennen und alle vier Datenverbindungen sowie die 
beiden Steuersignale überprüfen.
Wenn alle Verbindungen in Ordnung sind, sehe ich als Ursache nur noch die Möglichkeit einer
falschen Zeitabfolge der Steuersignale.
Die Ursache hierfür kann sein, dass der LCD-Controller langsamer ist als es die Software
des ATmega erwartet. Es könnte auch sein, dass der ATmega auf der falschen Taktrate läuft.
Bitte überprüfen Sie für welche Taktrate die Software übersetzt ist und ob
die fuses des ATmega für diese Geschwindigkeit richtig gesetzt sind.
Sie finden die eingestellte Taktrate in der betreffenden Makefile.
Wenn der Tester ohne die Abschalt-Elektronik aufgebaut ist, kann man mit einer
an die Test Pins angeschlossenen LED testen, ob das Programm arbeitet.
Wenn die LED flackert, läuft das Programm. Der Fehler muß in diesen Fall an
dem Anschluß des LCD's liegen. 
\item[Einiges, aber nicht alles ist auf der LCD-Anzeige lesbar] 
Überprüfen Sie ob die .eep Daten in den EEprom Speicher des ATmega geladen wurden.
Wenn alle Programmdaten richtig geladen wurden, sollten Sie die Taktrate ihrer
Programmdaten (Makefile) und die ATmega-Einstellungen prüfen (fuses).

\item[Messung ist zu langsam und Kapazitäten werden um Faktor 8 zu klein gemessen.] 
Sie betreiben die Software, die für 8MHz übersetzt wurde mit einer Taktrate von 1MHz.
Bitte konfigurieren Sie den ATmega mit den fuses richtig.

\item[Die Messung ergibt seltsame Ergebnisse]  
Überprüfe ob der ISP-Programmierstecker noch verbunden ist.
Der ISP-Stecker sollte nicht während einer Messung eingesteckt bleiben.
Sehr oft ist der Grund für falsche Messergebnisse, dass die Software mit der
 AUTOSCALE\_ADC Option und der NO\_REF\_CAP Option übersetzt wurde, aber der
Kondensator am AREF-Pin hat immer noch einen Wert von 100nF.
Falsche Bestückung von Bauteilen können auch eine Ursache für Messfehler sein 
oder zurückgebliebene Flussmittelreste können die Messung stören.
Bitte prüfen Sie nach Möglichkeit mit der Selbsttest-Funktion der
TransistorTester Software.
Zu den Einzelheiten schauen Sie in das Selbsttest Kapitel \ref{sec:selftest}.

Anderenfalls prüfen sie Ihre Platine visuell und prüfen Sie die Widerstandswerte
mit einem Ohmmeter. Sie können die Pins des ATmega für diese Prüfung benutzen,
zum Beispiel können Sie der Widerstand R1 zwischen Pin 23 und Pin 14 messen.
Schauen Sie in das Schaltbild \ref{fig:ttester} für die Einzelheiten.
Man braucht den Mikrocontroller nicht zu entfernen, nur die Stromversorgung sollte
vorher getrennt werden.

\end{description}
