
%\newpage
\section{Измерение частоты}
\label{sec:frequency}

Начиная с версии 1.10k в меню дополнительных функций можно выбрать пункт «Frequency» (измерение частоты). 
Стандартное измерение частоты осуществляется подсчетом количества задних фронтов входного сигнала по входу 
T0 (PD4) за одну секунду. Для получения периода счета в 1 секунду счетчик 1 используется с 
предделителем 256:1 частоты процессора.  
Для получения 1 секундного интервала за один проход можно использовать 16 разрядный счетчик ATmega 
с частотой процессора \(16~MHz\) и с предделителем.
Для запуска и остановки счетчика 0 используются регистры сравнения B и A счетчика 1. Чтобы избежать 
ошибки задержки при опросе результата сравнения сигналов событий, используются обработчики прерываний 
событий запуска и остановки счетчика 1. Времена задержек в обеих подпрограммах обслуживания прерываний 
практически равны. Для поддержания точности периода 1 секунда постоянная задержка незначительна. 
При анализе на ассемблере, разница во времени может быть скорректирована.\\

Для частот ниже \(25~kHz\) проводится стандартное измерение с последующим измерением периода времени. 
Это дополнительное измерение следует только после стандартного измерения частоты. Измерение времени 
будет сделано путем подсчета количества прерываний по входу PCINT20 (PD4) счетчиком 0.
При измерении периода импульса ширина как положительного, так и отрицательного полупериодов, 
должна быть не менее \(10~\mu s\).  
Счетчик 0 используется на максимальной тактовой частоте. Разрешение составляет  \(125~ns\) для
\(8~MHz\). При превышении подсчета периодов измерений разрешение может быть уменьшено. 
При использовании 125 периодов измерения, среднее разрешение для одного периода составит \(1~ns\). 
Для предотвращения неточности запуска и остановки счетчика 0, запуск будет
произведен по первому, а останов по последнему изменению на контакте прерывания PCINT20 по той же 
самой процедуре обслуживания прерывания. Количество периодов выбрано так, чтобы можно было измерить 
время около 10 миллионов тактов частоты процессора. При таком выборе ошибка составит 
всего \(0.1~ppm\). С тактовой частотой \(8~MHz\) время измерения составляет около 1,25 секунды. 
При определенной, таким образом, средней величине периода, частота вычисляется 
затем с более высоким разрешением.\\

Процедуру проверки проводили так: два Тестера измеряли друг друга. Первый тест: частоты генерируются 
Тестером 2 и измеряются Тестером 1. После этого Тестеры меняются местами, и измерения повторяются. 
На рисунке \ref{fig:freq-ppm} представлены результаты обеих серий измерений. Почти постоянные 
отклонения можно объяснить небольшой разницей частот двух кварцев.

\begin{figure}[H]
\centering
\input{../GNU/frequency-ppm}
\caption{Относительная погрешность измерения частоты}
\label{fig:freq-ppm}
\end{figure}

Подстройку частоты кварца можно осуществить установив подстроечный конденсатора (\(5-25~pF\)).
Успешно протестирована калибровка частоты кварца Тестера импульсами 1PPS с применением GPS приемника 
{\bf UP501} от {\bf Fastrax Ltd.} или с использованием GPS/GLONASS приемника {\bf GNS701} от {\bf Global 
Navigation Systems GmbH}.
Измеряемый период можно точно настроить на \(1000.000~ms\).
Только последняя цифра может отличаться на единицу.
Конечно, частота кристалла зависит от температуры. Поэтому вы не можете ожидать очень хорошую стабильность 
долгое время.

На рисунке \ref{fig:GPS-1PPS} приведена схема подключения UM232 USB-последовательного контроллера и
приемника к компьютеру.

Конвертер UM232 автоматически поддерживает два напряжения 5~V и 3.3~V 
для питания схемы от USB. 

Для работы приемника подключение к компьютеру не обязательно. 
Только питание 5~V необходимо подать USB контроллеру. 

\begin{figure}[H]
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=8.5cm]{../FIG/GPS_UP501.eps}
    \caption{GPS}
  \end{subfigure}
  ~
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=8.5cm]{../FIG/GPS_GNS701.eps}
    \caption{GPS/GLONASS}
  \end{subfigure}
  \caption{Генератор 1PPS сигнала от GPS приемника}
  \label{fig:GPS-1PPS}
\end{figure}


