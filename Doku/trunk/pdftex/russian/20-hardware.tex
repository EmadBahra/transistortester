\chapter{Аппаратные средства}

\section{Схема Тестера}
\label{sec:hardware}

Схема на рисунке \ref{fig:ttester} основана на схеме Markus F., из проекта AVR Transistortester \cite{Frejek}.
Измененные или перемещенные элементы отмечены \textcolor{green}{зеленым цветом}, дополнительные элементы отмечены \textcolor{red}{красным цветом}.\\

Небольшие изменения внесены в электронный выключатель питания, который создавал проблемы в некоторых реализациях. Резистор R7 уменьшен до  \(3.3k\Omega\). Конденсатор C2 уменьшен до 10 нФ. R8 перенесен так, чтобы вывод порта PD6 был подключен к конденсатору C2 через него, а не непосредственно.\\

Дополнительные блокировочные конденсаторы должны быть установлены у выводов питания ATmega и у выводов стабилизатора напряжения. 
Добавлен один дополнительный подтягивающий резистор на \(27k\Omega\) к выводу порта PD7 (вывод 13 ATmega). В этой модификации программное обеспечение отключает ВСЕ внутренние подтягивающие резисторы ATmega.\\
 
Добавлен дополнительный кварц на 8 МГц с конденсаторами C11, C12 на 22 пФ. Точность кварца дает возможность более точного измерения времени для того, чтобы измерить ёмкость конденсатора.\\

Новая версия программного обеспечения может использовать переключение масштаба напряжения АЦП. Скорость переключения зависит от внешнего конденсатора C1 на AREF (вывод 21 ATmega). Чтобы избежать замедления на величину большую, чем необходимо, ёмкость этого конденсатора должна быть уменьшена до 1 нФ. Можно вообще удалить конденсатор C1.\\

Соотношение резисторов R11/R12 определяет величину напряжения для контроля разряда батареи питания. Я приспособил свое программное обеспечение к оригиналу от  Markus F. \cite{Frejek} с величинами резисторов \(10k\Omega\) и \(3.3k\Omega\).
Дополнительное опорное напряжение 2.5 В, поданное на порт PC4 (ADC4), может использоваться, чтобы проверить и откалибровать Тестер на имеющееся напряжение VCC (не обязательно). В качестве ИОН можно использовать LM4040-AIZ2.5 (0.1\%),
LT1004CZ 2.5 (0.8\%) или LM336-Z2.5 (0.8\%).\\

Дополнительный интерфейс ISP был добавлен для упрощения загрузки новых версий программного обеспечения.
\begin{figure}[H]
\centering
\includegraphics[width=18cm]{../FIG/ttester.eps}
\caption{Новая схема Тестера}
\label{fig:ttester}
\end{figure}
Программное обеспечение может изменять назначение выводов порта D для удобства разводки LCD-дисплея (Версия Strip Grid). Соответствия представлены в таблице \ref{tab:grid-change}.

\begin{table}[H]
  \begin{center}
    \begin{tabular}{| c | c | c |}
    \hline
       Сигнал & Стандартная схема & Версия схемы strip grid\\
    \hline
    вход кнопки  &  PD7   &  PD0 \\
    LCD-RS    &  PD4      & PD7 \\
    LCD-E     &  PD5   & PD5 \\
    LCD-D4    &  PD0   & PD4 \\
    LCD-D5    &  PD1   & PD3 \\
    LCD-D6    &  PD2   & PD2 \\
    LCD-D7    &  PD3   & PD1 \\
    \hline
    \end{tabular}
  \end{center}
  \caption{Изменение для Serip Grid Board}
  \label{tab:grid-change}
\end{table}

Для лучшей защиты ATmega вводится дополнительная схема, представленная на рисунке~ \ref{fig:relay_addon} 
Контакты обесточенного реле защищают ATmega при отсутствии напряжения питания. Контакты будут разомкнуты программно, как только начнется измерение.

\begin{figure}[H]
\centering
\includegraphics[width=7cm]{../FIG/relay_addon.eps}
\caption{Защита входов ATmega}
\label{fig:relay_addon}
\end{figure}

Если UART не требуется, порт PC3 может использоваться в качестве аналогового входа для измерения внешнего напряжения. Напряжение может составить до 50 В с дополнительным резистивным делителем 10:1. На рисунке ~\ref{fig:zener} представлена схема для измерения напряжение пробоя стабилитрона при низком уровне на порте PD7 ATmega. Тестер показывает внешнее напряжение, пока Вы держите кнопку TEST нажатой. Ток, потребляемый от батареи питания, при этом возрастает до 40 мА.

\begin{figure}[H]
\centering
\includegraphics[width=12cm]{../FIG/zener_exp.eps}
\caption{Схема для измерения параметров стабилитронов}
\label{fig:zener}
\end{figure}

\section{Указания по сборке Тестера }

В Тестере может использоваться LCD-дисплей 2x16, программно совместимый с HD44780 или ST7036. Вы должны учитывать ток, необходимый для подсветки, некоторым LCD-дисплеям нужен ток ниже, чем другим. Я пытался применить OLED-дисплей, но он стал причиной помех при измерениях для ATmega, и я его {\bf не} рекомендую. Также использование OLED-дисплея вызвало проблему загрузки специального символа для 
отображения резистора.\\

Чтобы получить максимальную точность измерения, резисторы R1 - R6 \(680\Omega\) и
\(470k\Omega\) должны быть точными (0.1\%). В Тестере могут использоваться ATmega8, ATmega168 и ATmega328. Для возможности использовать все функции, необходимы ATmega168 или ATmega328.\\
 
Сначала Вы должны собрать все элементы Тестера на печатной плате без микроконтроллера. В качестве IC2 рекомендуется использовать стабилизатор с малым падением напряжения MCP1702-5002, потому что он потребляет всего  \(2\mu A\) и может выдавать 5 В при входном напряжение всего 5.4 В. Но он несовместим по выводам с известным 78L05 в корпусе TO92 .\\

После проверки правильности монтажа, необходимо подсоединить батарею или источник питание к плате без LCD-дисплея и микроконтроллера. При нажатой кнопке TEST должно присутствовать напряжение 5 В на выводах питания микроконтроллера и LCD дисплея. Если отпустить кнопку TEST, напряжение должно исчезнуть. Если  напряжения в норме, то необходимо отключить питание, ПРАВИЛЬНО вставить микроконтроллер и подключить LCD-дисплей. Перед подключением LCD дисплея необходимо внимательно проверить правильность соединения выводов питания LCD дисплея (т.к. на некоторых LCD дисплеях они подключены наоборот) с GND и VCC платы Тестера!\\
 
Если Вы уверены, что все в порядке, можно подсоединить питание. Если Вы уже запрограммировали ATmega, то можете нажать кнопку TEST. При нажатии кнопки TEST  светодиод LED1 и подсветка LCD-дисплея должны включиться. Если Вы отпускаете кнопку TEST, светодиод LED1 должен погаснуть. Заметьте, что программное обеспечение для микроконтроллера должно быть для используемого типа микроконтроллера. Программа для ATmega8 не работает на ATmega168!


\section{Доработки для версий Тестера Markus F.}
\label{sec:change_markus}
\begin{description}

\item[Контроль напряжения.]
Проблема проявляется следующим образом: Тестер немедленно отключается при каждом включении. Причиной может стать установка фьюзов (Makefile) контроля за понижением напряжения питания ATmega на 4.3 В. Происходит это следующим образом: порт PD6 пытается зарядить конденсатор C2 100 нФ до уровня VCC, что вызывает провал напряжения VCC (5 В). Для решения проблемы конденсатор C2 может быть уменьшен до \textless 10nF. Если возможно, то включить последовательно в цепь PD6  резистор сопротивлением более \textgreater \(220 \Omega\).
\item[Улучшение питания схемы.]
Если Тестер запускается при нажатии на кнопку TEST, но ключ сразу же отпускается, то часто причина этой проблемы в питании. Проблема порождена большим током подсветки LCD-дисплея. Резистор R7 к базе P-N-P-транзистора T3 был величиной \(27k \Omega\), 
чтобы уменьшить потребление энергии. Чтобы улучшить переключение при  более низком напряжении батареи или при низком коэффициенте усиления P-N-P транзистора T3, необходимо уменьшить сопротивление до \(3.3k \Omega\).
\item[Дополнительный подтягивающий резистор порта PD7.]
Отсутствие подтягивающего резистора, после короткого времени, работа заканчивается  выключением Тестера с сообщением «Timeout». Программное обеспечение формируется с опцией PULLUP\_DISABLE, т. е. все внутренние подтягивающие резисторы отключены. По этой причине напряжение порта PD7 не определено, если уровень не переключен кнопкой TEST или транзистором T2 к GND. Внешний резистор сопротивлением \(27k \Omega\) к VCC решает эту проблему.
\item[Конденсатор C1 в AREF.]
Многие используют на контакте AREF конденсатор на 100 нФ так же, как и Markus F. Пока не было необходимости менять опорное напряжение АЦП - это было хорошим решением. Программное обеспечение для ATmega168 и ATmega328 использует автоматический выбор внутреннего опорного напряжения АЦП 1.1 В, если входное напряжение ниже 1 В. Это позволяет улучшить разрешение АЦП при небольших входных напряжениях. К сожалению, переключение опорного напряжения от 5 В до 1.1 В происходит очень медленно. По этой причине нужно учитывать дополнительное время ожидания 10 мс. При уменьшении величины конденсатора до 1 нФ, это время может быть существенно уменьшено. Я не заметил ухудшения качества измерения при этом изменении. Даже с удалённым  конденсатором  нет существенного изменения результатов измерения. Если Вы предпочитаете оставить конденсатор на 100 нФ, то можете отключить опцию NO\_AREF\_CAP
в Makefile, для активации увеличения времени ожидания в программе.
\item[Установка кварца на 8 МГц.]
Вы можете установить кварц на 8 МГц с задней стороны печатной платы непосредственно к портам PB6 и PB7 (выводы 9 и 10). Моя собственная доработка была сделана без конденсаторов 22 пФ и работала хорошо со всеми проверенными  ATmega. Вы так же можете, выбрав фьюзы, использовать внутренний генератор на 8 МГц для получения лучшего разрешения по времени при стабильных измерениях (величины ёмкости).
\item[Сглаживание питающего напряжения.]
В оригинальной схеме Markus F. применен только один конденсатор 100 нФ по напряжению VCC. Это не дает приемлемую фильтрацию. Вы должны, по крайней мере, использовать конденсаторы ёмкостью 100 нФ около выводов питания ATmega и возле выводов входа и выхода стабилизатора напряжения. Дополнительные конденсаторы \(10\mu F\)
(электролитические или танталовые) на входе и выходе стабилизатора напряжения повышают устойчивость напряжения. Танталовый SMD конденсатор  \(10\mu F\) легче использовать со стороны печатных дорожек, и он имеет обычно более низкое значение ESR.
\item[Выбор микроконтроллера ATmega.]
Для основных функций Тестера возможно использование ATmega8, Flash память в ней используется практически на 100\%.
АТmega168 или АТmega328 совместимы по выводам с ATmega8, я могу рекомендовать замену. 
При использовании ATmega168 или АТmega328 Вы получаете следующие преимущества: 
Самопроверка с автоматической калибровкой.\\
Улучшение качества измерения с автоматическим переключением масштаба АЦП.\\
Измерение индуктивностей  при сопротивлении ниже \(2100 \Omega\).\\
Измерение величины ESR конденсаторов с ёмкостью выше \(0.18 \mu F\).\\
Измерение резисторов ниже \(10 \Omega\) с разрешением \(0.01 \Omega\).\\
Использование порта PC3 в качестве последовательного выхода или аналогового входа для измерения внешнего напряжения.\\
\item[Отсутствующие прецизионное опорное напряжение.]
Программное обеспечение должно обнаружить недостающие элементы опорного напряжения на выводе PC4. В этом случае при включении питания во второй строке LCD-дисплея должно появиться сообщение No VCC = x.xV. Если это сообщение появляется без информации, Вы должны подключить резистор \(2.2k \Omega\) между выводом PC4 и VCC.

\end{description}

\section{Китайские клоны }
По имеющейся у меня информации, Тестер выпускают в Китае в двух версиях. Первая модель первого дизайна от Markus F. без порта ISP. ATmega8 помещен в панельку, поэтому, Вы можете заменить его на ATmega168 или ATmega328. Для этой версии Вы должны рассмотреть все пункты раздела  \ref{sec:change_markus}.
Для лучшей стабилизации напряжения питания дополнительный керамический конденсатор на \(100nF\) должен быть установлен поблизости VCC-GND и выводов AVCC-GND ATmega. Кроме того, Вы должны иметь в виду, что, если Вы устанавливаете кварц на 8 МГц, то у Вашего внешнего программатора ISP должна быть частота синхронизации или кварц для программирования.\\

Вторая версия Тестера с элементами SMD. Там установлен ATmega168 в SMD корпусе 32TQFP. К счастью, установлен разъём ISP с 10 контактами для программирования. Я проанализировал версию платы "2.1 2012/11/06". Нашел одну ошибку - элемент "D1": установлен стабилитрон, а должен быть точный ИОН на 2.5 В. Стабилитрон необходимо удалить, а на его место установить ИОН LM4040AIZ2.5 или LT1004CZ-2.5. Недостающее опорное напряжение учитывается программным обеспечением даже, если ИОН не установлен. Мой образец был поставлен с программным обеспечением версии 1.02k. Разъём ISP с 10 контактами не был установлен, и я изготовил переходник от ISP6 к ISP10. У моего программатора цепь GND подведена к контакту 10, а на плате цепь GND подведена к контактам 4 и 6 ISP. Маркировка ATmega168 была стёрта, и не было никакой документации. Фьюзы блокировки ATmega были установлены таким образом, что бы считывание памяти было невозможно. Но установить программное обеспечение версии 1.05k удалось без проблем. У другого пользователя есть проблемы с программным обеспечением той же самой версии 1.05k. У этого пользователя китайская плата "2.2 2012/11/26". Программное обеспечение начинает работать, если установить дополнительный керамический конденсатор  \(100nF\) между выводами AVCC (вывод 18) и GND (вывод 21) ATmega. Программное обеспечение версии 1.05k использует режим сна ATmega в течение времени ожидания измерения. По этой причине ток потребления изменяется часто и регулятор напряжения нагружается больше. Далее я заметил, что напряжение VCC блокировано  керамическим конденсатором \(100nF\) и электролитическим конденсатором
\(220\mu F\) поблизости от 78L05. Входное напряжение 9 В блокировано теми же самыми конденсаторами, но не на входе стабилизатора, а в эмиттере P-N-P-транзистора (параллельно батарее). Дорожка от ATmega168 до испытательного порта настолько тонкая, что сопротивление \(100m \Omega\) не сможет быть измерено. Это будет причиной измерения сопротивления минимум \(0.3 \Omega\) для двух соединённых выводов. При измерении ESR эту величину обычно можно скомпенсировать. Программное обеспечение, начиная с версии 1.07k, учитывает это смещение для того, чтобы измерять резисторы сопротивлением ниже \(10 \Omega\).


\section{Программирование микроконтроллера}
Я публикую программное обеспечение для микроконтроллера ATmega с исходным кодом. Разработка сделана в среде операционной системы Linux (Ubuntu) и компилируется с помощью Makefile. Makefile даёт уверенность, что программное обеспечение будет корректно скомпилировано у Вас с предварительно выбранными опциями в Makefile. Некоторые структуры предкомпилированы с исходником. Пожалуйста, смотрите  ReadMe.txt файл в каталоге Software/default и главу~\ref{sec:config}.
Результат компиляции представлен файлами с двумя расширениями .hex и .eep. По умолчанию имена будут TransistorTester.hex и TransistorTester.eep. Файл с расширением .hex содержит данные для памяти программ (Flash), а файл с расширением .eep содержит данные для памяти EEprom  микроконтроллера ATmega. Оба файла с данными должны быть загружены в соответствующие области памяти микроконтроллера ATmega.\\

Дополнительные опции состояния микроконтроллера ATmega должны быть запрограммированы фьюзами.
Если Вы можете использовать мой Makefile с программой avrdude \cite{avrdude}, Вам не нужны детальные знания о фьюзах. Вы должны только выбрать "make fuses" , если у Вас нет кварца, или "make fuses-crystal" , если Вы установили кварц на 8 МГц на свою печатную плату. С серией ATmega168 Вы можете также использовать, "make fuses-crystal-lp" , чтобы использовать кварц с низким потреблением мощности. Никогда не выбирайте установки с кварцем, если кварц на 8 МГц у Вас не установлен. Если Вы не уверены с фьюзами, оставляете их заводскими и приведите Тестер в рабочее состояние в этом режиме. Работа программы может замедлиться, если Вы используете программные данные, определенные для работы на 8 МГц, но Вы сможете исправить это позже! А вот неправильный выбор фьюзов может запретить в будущем ISP-программирование. Конечно, программа avrdude должна поддерживать ваш программатор, и конфигурация в Makefile должна соответствовать Вашей среде разработки.\\ 

Если Вы используете операционную систему Windows, то самый легкий способ получить правильно запрограммированный ATmega состоит в том, чтобы использовать пакет WinAVR \cite{winavr1},\cite{winavr2}.
Для установки фьюзов с помощью Makefile Вы можете использовать мой Patch for WinAVR  \cite{winavr3}\\

На рисунке \ref{fig:WinAVR1} показано меню File графического интерфейса пользователя WinAVR для открытия файла Makefile (Open) и для того, чтобы сохранить изменённый Makefile (Save).

\begin{figure}[H]
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/Notepad_open.png}
    \caption{Открить Makefile}
  \end{subfigure}
  ~
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/Notepad_save.png}
    \caption{Сохранить Makefile}
  \end{subfigure}
  \caption{Использование программы WinAVR}
  \label{fig:WinAVR1}
\end{figure}

Следующий рисунок \ref{fig:WinAVR2} показывает меню Tools графического интерфейса пользователя WinAVR для того, чтобы скомпилировать программу (Make All) и для того, чтобы запрограммировать ATmega (Program) программой avrdude.

\begin{figure}[H]
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/Notepad_make.png}
    \caption{Создание прошивки (.hex/.eep)}
  \end{subfigure}
  ~
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/Notepad_program.png}
    \caption{Программирование ATmega}
  \end{subfigure}
  \caption{Использование WinAVR}
  \label{fig:WinAVR2}
\end{figure}



\section{Поиск неисправностей }
В большинстве случаев возникают проблемы с выводом текста на LCD-дисплей. Сначала Вы должны проверить, что светодиод LED1 не светится, если Вы отпускаете кнопку TEST. 
\begin{description}

\item[Питание не включается.]
Если светодиод LED1 не светится, и VCC = 5 В во время нажатия кнопки TEST, микроконтроллер не включает питание. В первую очередь, микроконтроллер должен держать питание, переключая уровень PD6 на 5 В. Если Вы удерживаете кнопку TEST, питание должно быть включено. Так Вы можете проверить величину напряжения питания VCC и одновременно величину напряжения на PD6. Если напряжения VCC = 5 В, а напряжение на PD6 ниже 4 В, то микроконтроллер не запускает программу. В этом случае Вы должны проверить, был ли микроконтроллер запрограммирован надлежащими данными для установленного у Вас типа ATmega во Flash и EEprom, и правильно ли сформированы фьюзы. Если микроконтроллер переводит состояние PD6 в 5 В, но питание не остается после отпускания кнопки TEST, то это усложняет поиск причины. Сначала Вы можете замкнуть светодиод LED1 и попробовать еще раз. Если Тестер запускается, то светодиод LED1 может быть дефектным или установлен с неправильной полярностью. Если причина не эта, то недостаточен коэффициент усиления транзистора T3 (BC557C).

\item[Отсутствует текст на LCD-дисплее.]
Проверьте напряжение на контакте контрастности в LCD-дисплее. Установите значение, определенное в техническом описании. Отсутствующий текст на LCD-дисплее может быть вызван неправильным монтажом или выбором временных параметров. Если на LCD-дисплее нет никакой информации, а подсветка есть, то необходимо отключить питание и проверить четыре шины данных и две связи управляющих сигналов. Если всё нормально, единственной причиной, которую я вижу, является неправильный выбор временніх параметров управляющих сигналов. Это может быть вызвано более медленным контроллером LCD-дисплея, чем заложено в программном обеспечении или работой программного обеспечения на неправильной тактовой частоте ATmega. Необходимо проверить, для какой тактовой частоты были скомпилированы программные данные, и соответствуют ли фьюзы, выбранной частоте ATmega. Вы найдёте параметр частоты в соответствующей строке Makefile. Если Тестер собран без отключения, Вы можете проверить работу программы с помощью светодиода, подключенного к испытательным выводам. Если светодиод мигает, то программа работает правильно.


\item[Что-то, но не все читаемое на LCD-дисплее.]
Проверить, правильные ли .eep данные загружены в память EEprom  ATmega. Если все данные загружены правильно, то необходимо проверить тактовую частоту, программные параметры данных (Makefile) и установки фьюзов ATmega.

\item[Медленное измерение и измеренная ёмкость в 8 раз меньше.] 
Программное обеспечение для 8 МГц, а работает ATmega на 1 МГц. Проверьте правильность установки фьюзов.

\item[Странные значения измерений.]
Для того, чтобы проводить измерения, ISP программатор должен быть отсоединен. Очень часто причина неправильных измерений - использование программного обеспечения, скомпилированного с опцией AUTOSCALE\_ADC и с опцией NO\_REF CAP, а на выводе AREF конденсатор ёмкостью 100 нФ. Неправильный монтаж или остатки флюса также могут нарушить измерение. Пожалуйста, если возможно, проверьте функцией самопроверки программное обеспечение Тестера. Подробности смотрите в Главе \ref{sec:selftest}

Осмотрите свою плату визуально и проверьте величины резисторов омметром. Для этой проверки Вы можете использовать выводы ATmega, например, чтобы проверить R1, Вы можете провести измерения между выводами 23 и 14 ATmega. Смотрите схему на рисунке \ref{fig:ttester} Удалять микроконтроллер не обязательно, достаточно только отключить батарею или электропитание.

\item[Тестер выключает питание после 2 секунд отображения на дисплее.] 
Это может произойти, если отсутствует внешний подтягивающий резистор с порта PD7 к VCC, или кнопка TEST удерживается нажатой. Программное включение внутренних подтягивающих резисторов влияет на результаты измерения, поэтому необходим внешний подтягивающий резистор \(27k \Omega\). 

\end{description}
