\chapter{Аппаратные средства}

\section{Схема Тестера}
\label{sec:hardware}

Схема на рисунке \ref{fig:ttester} основана на схеме Markus F., из проекта AVR Transistortester \cite{Frejek}.
Измененные или перемещенные элементы отмечены \textcolor{green}{зеленым цветом}, дополнительные элементы 
отмечены \textcolor{red}{красным цветом}.\\

Небольшие изменения внесены в электронный выключатель питания, который создавал проблемы в некоторых реализациях. 
Резистор R7 уменьшен до  \(3.3~k\Omega\). Конденсатор C2 уменьшен до \(10~nF\). R8 перенесен так, чтобы вывод порта 
PD6 был подключен к конденсатору C2 через него, а не непосредственно.\\

Дополнительные блокировочные конденсаторы должны быть установлены у выводов питания ATmega и у выводов стабилизатора 
напряжения. 
Добавлен один дополнительный подтягивающий резистор на \(27~k\Omega\) к выводу порта PD7 (вывод 13 ATmega). В этой 
модификации программное обеспечение отключает ВСЕ внутренние подтягивающие резисторы ATmega.\\
 
Добавлен дополнительный кварц на \(8~MHz\) с конденсаторами C11, C12 на \(22~pF\). Точность кварца дает возможность 
более точного измерения времени для того, чтобы измерить ёмкость конденсатора.\\

Новая версия программного обеспечения может использовать переключение масштаба напряжения АЦП. Скорость переключения 
зависит от внешнего конденсатора C1 на AREF (вывод 21 ATmega). Чтобы избежать замедления на величину большую, чем 
необходимо, ёмкость этого конденсатора должна быть уменьшена до \(1~nF\). Можно вообще удалить конденсатор C1.\\

Соотношение резисторов R11/R12 определяет величину напряжения для контроля разряда батареи питания. Я приспособил свое 
программное обеспечение к оригиналу от  Markus F. \cite{Frejek} с величинами резисторов \(10~k\Omega\) и \(3.3~k\Omega\).
Дополнительное опорное напряжение \(2.5~V\), поданное на порт PC4 (ADC4), может использоваться, чтобы проверить и 
откалибровать Тестер на имеющееся напряжение VCC (не обязательно). В качестве ИОН можно использовать LM4040-AIZ2.5 
(0.1\%), LT1004CZ 2.5 (0.8\%) или LM336-Z2.5 (0.8\%).\\

Если не установлен ИОН и не предусмотрена защита с использованием реле, Вы должны установить подтягивающий резистор 
R16 к PC4 с высоким номиналом (\(47~k\Omega\)). Это поможет программному обеспечению обнаружить отсутствующий ИОН. 
Дополнительный интерфейс ISP был добавлен для упрощения загрузки новых версий программного обеспечения.
\begin{figure}[H]
\centering
\includegraphics[width=18cm]{../FIG/ttester.eps}
\caption{Новая схема Тестера}
\label{fig:ttester}
\end{figure}
Программное обеспечение может изменять назначение выводов порта D для удобства разводки LCD-дисплея. 
В таблице \ref{tab:grid-change} показано варианты подключения для версии Strip Grid и подключения графического 
индикатора к микроконтроллеру ATmega8/168/328.
Также указано использование входов портов для дополнительных функций.
При подсоединении графического адаптера к плате версии Strip Grid (опция STRIP\_GRID\_BOARD)
функция измерения частоты не может быть использована, потому что порт PD4 (T0) используется.
Но это соединение используется в китайской версии с графическим дисплеем.


\begin{table}[H]
  \begin{center}
    \begin{tabular}{| c || c | c | c | c | c | c |}
    \hline
      Порт & Символь-    & Симв. LCD   & ST7565   & ST7565 LCD  & SSD1306 & Дополнительные \\
           & ный LCD     & strip\_grid &   LCD    & strip\_grid &   I2C   & функции \\
    \hline                                                                      
    \hline                                                                      
    PD0    &  LCD-D4     & кнопка      & LCD-REST &             &         & \\
    \hline                                                                      
    PD1    &  LCD-D5     & LCD-D7      & LCD-RS   & LCD-SI      &         & 2 канал энкодера \\
    \hline                                                                      
    PD2    &  LCD-D6     & LCD-D6      & LCD-SCLK & LCD-SCLK    & LCD-SDA & \\
    \hline                                                                      
    PD3    &  LCD-D7     & LCD-D5      & LCD-SI   & LCD-A0 (RS) &         & 1 канал энкодера \\
    \hline                                                                      
    PD4    &  LCD-RS     & LCD-D4      &          & LCD-REST    &         & внешняя частота \\
    \hline                                                                     
    PD5    &  LCD-E      & LCD-E       &          &             & LCD-SCL &  \\
    \hline                                                                      
    PD7    &  кнопка     & LCD-RS      &          &             &         &  \\
    \hline
    \end{tabular}
  \end{center}
  \caption{Подключения дисплеев к портам ATmega8/168/328}
  \label{tab:grid-change}
\end{table}


\section{Улучшения и расширения к прибору}

\subsection{Защита портов ATmega}

Для защиты ATmega вводится одина из двух вариантов схемы защиты из представленных на рисунке~ \ref{fig:relay_addon} 
В первом варианте контакты обесточенного реле защищают ATmega при отсутствии напряжения питания. Контакты будут разомкнуты программно, 
как только начнется измерение.\\

Во втором варианте защита при помощи диодов уменьшает вероятность повреждения портов ATmega при подключении 
конденсатора с остаточным напряжением.\\

Следует заметить, что ни одна схема не дает полной гарантии защиты ATmega от остаточного заряда конденсатора.
По этому, перед тестированием, конденсатор обязательно разрядить!  

\begin{figure}[H]
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=7cm]{../FIG/relay_addon.eps}
    \caption{с использованием реле}
  \end{subfigure}
  ~
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=7cm]{../FIG/diode_addon.eps}
    \caption{с использованием диодов}
  \end{subfigure}
  \caption{Защита входов ATmega}
  \label{fig:relay_addon}
\end{figure}



\subsection{Измерение стабилитронов с напряжением более 4 V}

Если UART не требуется, порт PC3 может использоваться в качестве аналогового входа для измерения внешнего напряжения. 
Напряжение может составить до \(50~V\) с дополнительным резистивным делителем 10:1. На рисунке ~\ref{fig:zener} 
представлена схема для измерения напряжение пробоя стабилитрона при низком уровне на порте PD7 ATmega. 
Тестер показывает внешнее напряжение, пока Вы держите кнопку {\bf TEST} нажатой. Ток, потребляемый от батареи питания, 
при этом возрастает, примерно, на \(40~mA\).

\begin{figure}[H]
\centering
\includegraphics[width=18cm]{../FIG/zener_exp.eps}
\caption{Схема для измерения параметров стабилитронов}
\label{fig:zener}
\end{figure}

Резистивный делитель 10:1 может быть использован для измерения внешних напряжений при выборе из
меню дополнительных функций в ATmega328. Присутствие DC-DC преобразователя для измерения стабилитронов
не мешает, так как кнопка не удерживается в нажатом состоянии и, соответственно, DC-DC преобразователь
обесточен. Таким образом, можно измерять напряжение постоянного тока до \(50~V\) только положительной 
полярности, обязательно соблюдая полярность.\\

\subsection{Генератор частоты}

Из меню дополнительных функций, при использовании ATmega328, можно выбрать генератор частоты.
В настоящее время поддерживается выбор частот в диапазоне от \(1~Hz\) до \(2~MHz\). 
Выходной сигнал \(5~V\) через резистор \(680~\Omega\) выводится на тестовый контакт TP2.
В качестве сигнала GND, при этом, можно использовать GND DC-DC преобразователя или тестовый 
контакт TP1. Тестовый контакт TP3 подсоединен к GND через резистор \(680~\Omega\).
Конечно, Вы также можете использовать порт PB2 для подключения отдельной схемы усилителя-формирователя.
Но вход этой схемы не должен создавать большую нагрузку для порта ATmega.\\

\subsection{Измерение частоты}

Для использования дополнительной функции измерения частоты, потребуется незначительная 
доработка Тестера. Для измерения частоты используется порт PD4 (T0/PCINT20) ATmega. 
Этот же порт используется для подключения LCD-дисплея. В стандартном варианте к порту PD4 подключен 
сигнал LCD-RS, в варианте strip grid - сигнал LCD-D4. Для обоих сигналов порт PD4 может быть переключен 
на ввод, если в данный момент не требуется выводить информацию на LCD-дисплей.\\
 
Однако, лучше использовать дополнительную схему подключения, изображенную на рисунке~\ref{fig:FreqMes}.
Напряжение на выводе порта PD4 (LCD-RS или LCD-D4) должно быть установлено около \(2.4~V\) при отключенной 
ATmega или подстроено во время измерения частоты ATmega, чтобы получить лучшую чувствительность к входному 
сигналу. Во время регулировки LCD-дисплей должен быть установлен, потому что подтягивающие резисторы 
индикатора могут изменить установленное напряжение.

\begin{figure}[H]
\centering
\includegraphics[width=7cm]{../FIG/Frequency_addon.eps}
\caption{Дополнительная схема для измерения частоты}
\label{fig:FreqMes}
\end{figure}

\subsection{Использование поворотного энкодера}

Для более удобного доступа к Меню дополнительных функций для ATmega328, Вы можете дополнить схему, установив
инкрементальный энкодер с кнопкой.   
Рисунок~\ref{fig:RotExt} показывает схему подключения к тестеру с символьным LCD.
Все сигналы для подключения поворотного инкрементального энкодера доступны в разъеме 
подключения LCD. По этому, модернизация возможна для большинства существующих тестеров.
Во многих случаях графический LCD собран на переходной плате и подключен к контактам, предназначенным
для подключения символьного LCD. Таким образом, модернизация в этих случаях также возможна.    

\begin{figure}[H]
\centering
\includegraphics[width=6cm]{../FIG/rotary_extension.eps}
\caption{Схема подключения поворотного энкодера}
\label{fig:RotExt}
\end{figure}

На рисунке~\ref{fig:RotEnc} показана особенность работы двух типов поворотных инкрементальных 
энкодеров.
В версии 1 полная последовательность состояния переключателей происходит при повороте на два 
фиксированные положения. Количество полных циклов в два раза меньше чем количество фиксированных
положений за оборот энкодера.
В версии 2 при повороте на одно фиксированное положение генерируется полный цикл состояния контактов. 
В этом случае количество фиксированных положений соответствует количеству циклов за оборот энкодера.  
Иногда, в таких энкодерах, в каждом фиксированном положении состояние переключателей всегда 
одинаково.

\begin{figure}[H]
\centering
\includegraphics[width=14cm]{../FIG/rotary_encoder.eps}
\caption{Особенности двух типов поворотных инкрементальных энкодеров}
\label{fig:RotEnc}
\end{figure}

Рисунок~\ref{fig:RotBounce} показывает работу энкодера который имеет не только «дребезг» контактов
но и неустойчивое состояние переключателя в точке фиксации. Каждое изменение 
состояния переключателей определяется программой и сохраняется в циклический буфер.
Поэтому, последние три состояния переключателей можно проверить после каждого изменения состояния.
Для каждого цикла переключения состояний, в общей сложности четыре последовательности могут быть 
определены для каждого направления вращения.

Если за одну фиксированную позицию осуществляется один, полный, цикл состояний переключателей, то для правильного
подсчета достаточно контролировать состояние переключателя в одном канале (WITH\_ROTARY\_SWITCH=2 или 3).

Если для генерации полного цикла состояний переключателей требуется поворот на две фиксированные
позиции, как показано на рисунке~\ref{fig:RotBounce}, Вы должны контролировать последовательность
переключения в двух каналах (WITH\_ROTARY\_SWITCH=1).
  
Для энкодеров без фиксации, Вы можете выбрать любую чувствительность к углу поворота. Значение 
2 и 3 устанавливает низкую чувствительность, 1 среднюю чувствительность и 5 высокую чувствительность.
 
Подсчет импульсов (количество «вверх», количество «вниз») может быть обеспечен подбором 
определенного алгоритма, но, в то же время, может быть утрачен из-за неустойчивого состояния 
контактов переключателей в точке фиксации.

\begin{figure}[H]
\centering
\includegraphics[width=14cm]{../FIG/rotary_bouncing.eps}
\caption{Энкодер с «дребезгом» контактов переключателей}
\label{fig:RotBounce}
\end{figure}

Если энкодер не доступен или не целесообразен из-за конструктивных соображений, вместо двух контактов энкодера, 
Вы можете подсоединить две независимые кнопки для перемещения «Вверх» и «Вниз».
В этом случае значение опции WITH\_ROTARY\_SWITCH, для корректной работы программы, должно быть установлено 4.

\subsection{Подключение графического дисплея}

Большое спасибо Wolfgang Sch. за выполненную работу по поддержке прибором китайской версии дисплея с контроллером ST7565.
В настоящее время вы также можете подключить графический LCD (128x64 пикселей) с контроллером ST7565. 
Поскольку контроллер ST7565 подключается по последовательному интерфейсу, то только четыре сигнальных
линии используется. Два вывода порта D ATmega могут быть использованы для других задач.
ATmega процессор должен иметь, по крайней мере, \(32~kB\) флеш-памяти для поддержки графического дисплея.
ST7565 контроллер использует рабочее напряжение \(3.3~V\).
Поэтому требуется дополнительный стабилизатор \(3.3~V\).
Документация к контроллеру ST7565 не допускает прямого подключения логических 
сигналов уровня \(5~V\). Для согласования логических уровней сигналов \(5~V\) и \(3.3~V\) можно использовать
схему, приведенную на рисунке \ref{fig:ST7565lcd} с использованием 
микросхемы преобразователя уровней 74HC4050.
Вы можете попробовать применить вместо четырех элементов 74HC4050 четыре резистора, примерно \(2.7~k\Omega\).
Падение напряжения на резисторах предотвратит увеличение напряжения на входах графического контроллера больше чем
напряжение питания \(3.3~V\), а дополнительные диоды на входах графического контроллера не допустят попадания 
выходного сигнала \(5~V\) от ATmega.
Вы должны убедиться, что форма сигналов с резисторов могут быть правильно восприняты входами контроллера ST7565.
 
В любом случае, при применении элементов микросхемы 74HC4050 форма сигнала на входе графического контроллера 
точнее соответствует форме выходного сигнала с ATmega. 

Обычно ST7565 или SSD1306 контроллер подключается по 4-проводному SPI интерфейсу.
Но с контроллером SSD1306 Вы также можете подключить индикатор с шиной I2C использовав PD2 
как SDA и PD5 как SCL сигнал.
Сигналы SDA и SCL должны быть подтянуты резисторами около \(4.7~k\Omega\) к напряжению \(3.3~V\).
Сигнали шины I2C реализованы только путем переключения портов ATmega к \(0~V\).
Перед подключением подтягивающих резисторов к напряжению \(5~V\), Вы должны убедиться, что Ваш контроллер
допускает уровень сигнала \(5~V\).

\begin{figure}[H]
\centering
\includegraphics[width=14cm]{../FIG/ST7565lcd.eps}
\caption{Подключение графического дисплея}
\label{fig:ST7565lcd}
\end{figure}

Для подключения к контроллерам сериии ATmega644 вместо портов PD0 - PD3 используются порты PB2 - PB5.
Для замены символьного дисплея на графический можно использовать переходную печатную плату-адаптер с разъемом
аналогичным символьному LCD, так как все сигналы и питание на нем доступны.

\section{Указания по сборке Тестера }

В Тестере может использоваться LCD-дисплей 2x16, программно совместимый с HD44780 или ST7036. Вы должны учитывать ток, 
необходимый для подсветки, некоторым LCD-дисплеям нужен ток ниже, чем другим. Я пытался применить OLED-дисплей, но он 
стал причиной помех при измерениях для ATmega, и я его {\bf не} рекомендую. Также использование OLED-дисплея вызвало 
проблему загрузки специального символа для отображения резистора.\\

Чтобы получить максимальную точность измерения, резисторы R1 - R6 \(680~\Omega\) и
\(470~k\Omega\) должны быть точными (0.1\%). В Тестере могут использоваться ATmega8, ATmega168 и ATmega328. Для 
возможности использовать все функции, необходимы ATmega168 или ATmega328.\\
 
Сначала Вы должны собрать все элементы Тестера на печатной плате без микроконтроллера. В качестве IC2 рекомендуется 
использовать стабилизатор с малым падением напряжения MCP1702-5002, потому что он потребляет всего  \(2~\mu A\) и может 
выдавать \(5~V\) при входном напряжение всего \(5.4~V\). Но он несовместим по выводам с известным 78L05 в корпусе TO92 .\\

После проверки правильности монтажа, необходимо подсоединить батарею или источник питание к плате без LCD-дисплея и 
микроконтроллера. При нажатой кнопке {\bf TEST} должно присутствовать напряжение \(5~V\) на выводах питания 
микроконтроллера и LCD дисплея. Если отпустить кнопку {\bf TEST}, напряжение должно исчезнуть. Если  напряжения 
в норме, то необходимо отключить питание, {\bf правильно} вставить микроконтроллер и подключить LCD-дисплей. 
Перед подключением LCD дисплея необходимо 
внимательно проверить правильность соединения выводов питания LCD дисплея (т.к. на некоторых LCD дисплеях они 
подключены наоборот) с GND и VCC платы Тестера!\\
 
Если Вы уверены, что все в порядке, можно подсоединить питание. Если Вы уже запрограммировали ATmega, то можете 
кратковременно нажать кнопку {\bf TEST}. При кратковременном нажатии кнопки {\bf TEST} светодиод LED1 и подсветка 
LCD-дисплея должны включиться. 
Если Вы отпускаете кнопку {\bf TEST}, светодиод LED1 не должен гаснуть как минимум несколько секунд 
(зависит от установленных параметров при компилляции программного обеспечения). 
Заметьте, что программное обеспечение для микроконтроллера должно быть для используемого типа микроконтроллера. Программа для ATmega8 не работает на ATmega168!


\section{Доработки для версий Тестера Markus F.}
\label{sec:change_markus}
\begin{description}

\item[Контроль напряжения.]
Проблема проявляется следующим образом: Тестер немедленно отключается при каждом включении. Причиной может стать 
установка фьюзов (Makefile) контроля за понижением напряжения питания ATmega на \(4.3~V\). Происходит это следующим 
образом: порт PD6 пытается зарядить конденсатор C2 \(100~nF\) до уровня VCC, что вызывает провал напряжения 
VCC (\(5~V\)). Для решения проблемы конденсатор C2 может быть уменьшен до \textless~\(10~nF\). Если возможно, 
то включить последовательно в цепь PD6  резистор сопротивлением более \textgreater~\(220~\Omega\).
\item[Улучшение питания схемы.]
Если Тестер запускается при нажатии на кнопку {\bf TEST}, но ключ сразу же отпускается, то часто причина этой проблемы 
в питании. Проблема порождена большим током подсветки LCD-дисплея. Резистор R7 к базе P-N-P-транзистора T3 был 
величиной \(27~k\Omega\), 
чтобы уменьшить потребление энергии. Чтобы улучшить переключение при  более низком напряжении батареи или при низком 
коэффициенте усиления P-N-P транзистора T3, необходимо уменьшить сопротивление до \(3.3~k\Omega\).
\item[Дополнительный подтягивающий резистор порта PD7.]
Отсутствие подтягивающего резистора, после короткого времени, работа заканчивается  выключением Тестера с сообщением 
«Timeout». Программное обеспечение формируется с опцией PULLUP\_DISABLE, т. е. все внутренние подтягивающие резисторы 
отключены. По этой причине напряжение порта PD7 не определено, если уровень не переключен кнопкой {\bf TEST} или 
транзистором T2 к GND. Внешний резистор сопротивлением \(27~k\Omega\) к VCC решает эту проблему.
\item[Конденсатор C1 в AREF.]
Многие используют на контакте AREF конденсатор на \(100~nF\) так же, как и Markus F. Пока не было необходимости менять 
опорное напряжение АЦП - это было хорошим решением. Программное обеспечение для ATmega168 и ATmega328 использует 
автоматический выбор внутреннего опорного напряжения АЦП \(1.1~V\), если входное напряжение ниже \(1~V\). Это позволяет 
улучшить разрешение АЦП при небольших входных напряжениях. К сожалению, переключение опорного напряжения от \(5~V\) до 
\(1.1~V\) происходит очень медленно. По этой причине нужно учитывать дополнительное время ожидания \(10~ms\). 
При уменьшении величины конденсатора до \(1~nF\), это время может быть существенно уменьшено. Я не заметил ухудшения 
качества измерения при этом изменении. Даже с удалённым конденсатором нет существенного изменения результатов 
измерения. Если Вы предпочитаете оставить конденсатор на \(100~nF\), то можете отключить опцию NO\_AREF\_CAP
в Makefile, для активации увеличения времени ожидания в программе.
\item[Установка кварца на \(8~MHz\).]
Вы можете установить кварц на \(8~MHz\) с задней стороны печатной платы непосредственно к портам PB6 и PB7 
(выводы 9 и 10). Моя собственная доработка была сделана без конденсаторов \(22~pF\) и работала хорошо со всеми 
проверенными ATmega. Вы так же можете, выбрав фьюзы, использовать внутренний генератор на \(8~MHz\) для получения 
лучшего разрешения по времени при стабильных измерениях (величины ёмкости).
\item[Сглаживание питающего напряжения.]
В оригинальной схеме Markus F. применен только один конденсатор \(100~nF\) по напряжению VCC. Это не дает приемлемую 
фильтрацию. Вы должны, по крайней мере, использовать конденсаторы ёмкостью \(100~nF\) около выводов питания ATmega и 
возле выводов входа и выхода стабилизатора напряжения. Дополнительные конденсаторы \(10~\mu F\)
(электролитические или танталовые) на входе и выходе стабилизатора напряжения повышают устойчивость напряжения. 
Танталовый SMD конденсатор  \(10~\mu F\) легче использовать со стороны печатных дорожек, и он имеет обычно более 
низкое значение ESR.
\item[Выбор микроконтроллера ATmega.]
Для основных функций Тестера возможно использование ATmega8, Flash память в ней используется практически на 100\%.
АТmega168 или АТmega328 совместимы по выводам с ATmega8, я могу рекомендовать замену. 
При использовании ATmega168 или АТmega328 Вы получаете следующие преимущества: 
Самопроверка с автоматической калибровкой.\\
Улучшение качества измерения с автоматическим переключением масштаба АЦП.\\
Измерение индуктивностей  при сопротивлении ниже \(2100~\Omega\).\\
Измерение величины ESR конденсаторов с ёмкостью выше \(90~nF\).\\
Измерение резисторов ниже \(10~\Omega\) с разрешением \(0.01~\Omega\).\\
Использование порта PC3 в качестве последовательного выхода или аналогового входа для измерения внешнего напряжения.\\
\item[Отсутствующие прецизионное опорное напряжение.]
Программное обеспечение должно обнаружить недостающие элементы опорного напряжения на выводе PC4. В этом случае при 
включении питания во второй строке LCD-дисплея должно появиться сообщение Тип «No VCC = x.xV». Если это сообщение 
появляется при установленном ИОН, Вы должны подключить резистор \(2.2~k\Omega\) между выводом PC4 и VCC.

\end{description}

\section{Китайские клоны }
По имеющейся у меня информации, Тестер выпускают в Китае в двух версиях. Первая модель первого дизайна от Markus F. 
без порта ISP. ATmega8 помещен в панельку, поэтому, Вы можете заменить его на ATmega168 или ATmega328. Для этой версии 
Вы должны рассмотреть все пункты раздела  \ref{sec:change_markus}.
Для лучшей стабилизации напряжения питания дополнительный керамический конденсатор на \(100~nF\) должен быть установлен 
поблизости VCC-GND и выводов AVCC-GND ATmega. Кроме того, Вы должны иметь в виду, что, если Вы устанавливаете кварц 
на \(8~MHz\), то у Вашего внешнего программатора ISP должна быть частота синхронизации или кварц для программирования.\\

Вторая версия Тестера с элементами SMD. Там установлен ATmega168 в SMD корпусе 32TQFP. К счастью, установлен разъём ISP 
с 10 контактами для программирования. Я проанализировал версию платы «2.1 2012/11/06». Нашел одну ошибку - элемент «D1»: 
установлен стабилитрон, а должен быть точный ИОН на \(2.5~V\). Стабилитрон необходимо удалить, а на его место установить 
ИОН LM4040AIZ2.5 или LT1004CZ-2.5. Недостающее опорное напряжение учитывается программным обеспечением даже, если ИОН 
не установлен. Мой образец был поставлен с программным обеспечением версии 1.02k. Разъём ISP с 10 контактами не был 
установлен, и я изготовил переходник от ISP6 к ISP10. У моего программатора цепь GND подведена к контакту 10, а на 
плате цепь GND подведена к контактам 4 и 6 ISP. Маркировка ATmega168 была стёрта, и не было никакой документации. 
Фьюзы блокировки ATmega были установлены таким образом, что бы считывание памяти было невозможно. Но установить 
программное обеспечение версии 1.05k удалось без проблем. У другого пользователя есть проблемы с программным 
обеспечением той же самой версии 1.05k. У этого пользователя китайская плата «2.2 2012/11/26». Программное обеспечение 
начинает работать, если установить дополнительный керамический конденсатор  \(100~nF\) между выводами AVCC (вывод 18) и 
GND (вывод 21) ATmega. Программное обеспечение версии 1.05k использует режим сна ATmega в течение времени ожидания 
измерения. По этой причине ток потребления изменяется часто и регулятор напряжения нагружается больше. Далее я заметил, 
что напряжение VCC блокировано керамическим конденсатором \(100~nF\) и электролитическим конденсатором
\(220~\mu F\) поблизости от 78L05. Входное напряжение \(9~V\) блокировано теми же самыми конденсаторами, но не на входе 
стабилизатора, а в эмиттере P-N-P-транзистора (параллельно батарее). Дорожка от ATmega168 до испытательного порта 
настолько тонкая, что сопротивление \(100~m\Omega\) не сможет быть измерено. Это будет причиной измерения сопротивления 
минимум \(0.3~\Omega\) для двух соединённых выводов. При измерении ESR эту величину обычно можно скомпенсировать. 
Программное обеспечение, начиная с версии 1.07k, учитывает это смещение для того, чтобы измерять резисторы 
сопротивлением ниже \(10~\Omega\).

Новые сборки тестера, как, например, версия от Fish8840 используют 128x64 точки графический дисплей.
Эта версия использует модифицированную логику управления питанием и кнопками. 
Рисунок \ref{fig:Fish8840} показывает часть модифицированной схемы.

\begin{figure}[H]
\centering
\includegraphics[width=12cm]{../FIG/Fish8840.eps}
\caption{Часть схемы версии от Fish8840}
\label{fig:Fish8840}
\end{figure}

Как Вы можете видеть, вместо исходного коэффициента делителя, соотношение сопротивлений резисторов в цепи измерения 
напряжения батареи, R8 и R15 выбрано 2:1.
Кроме того, резистор R15 подключен непосредственно к батареи, что приводит к потреблению энергии в выключенном состоянии. 
Резистор R15 должен быть подключен к стоку Q1 или на вход регулятора напряжения для предотвращения ненужного 
расхода энергии батареи.
Коэффициент делителя для измерения напряжения батареи должен быть задан в Makefile после внесения
изменений в оригинальное программное обеспечение (BAT\_NUMERATOR=66 for example).
Все попытки изменить программное обеспечение Вы делаете на свой страх и риск.
Никаких гарантий не может быть дано по поддержанию новых версий.

К сожалению, исходная китайская микропрограмма не может быть сохранена 
из-за установленных битов защиты ATmega328. Так что нет способа вернуть прибор в исходное состояние.

\section{Расширенная схема с ATmega644 или ATmega1284}

Расширенная схема для контроллеров ATmega644/1284 разработана совместно с Nick L. из Украины.
Схема \ref{fig:t644tester} позволяет расширить диапазон измеряемых частот, а также содержит схему 
тестирования кварцев. 
Хотя расширенная схема почти идентична схеме на рисунке \ref{fig:ttester}, 
назначение портов несколько отличается.
Поворотный энкодер на схеме \ref{fig:RotExt} должен быть подключен к PB5 и PB7 (вместо PD1 и PD3).
Оба сигнала, а также VCC и GND доступны на разъеме программирования ISP. Таким образом, подключение
поворотного энкодера не должно вызвать затруднений.
Делитель 16:1 в 74HC4060 всегда используется для частот выше \(2~MHz\). 
Он также может быть использован для частот от \(24~kHz\) до \(400~kHz\) для повышения точности
измерения частоты с помощью подсчета периода.
Для коммутации переключений (делитель частоты и кварцевый генератор) используется 
аналоговый переключатель 74HC4052.
Таблица \ref{tab:mega644-display} показывает варианты подключения дисплея к портам 
ATmega324/644/1284.
Подключение индикатора с использованием интерфейса I2C возможно только для индикаторов с 
контроллером SSD1306.
Сигналы интерфейса I2C требуют установки подтягивающих резисторов \(4.7k\Omega\) к напряжению \(3.3~V\).
Сигналы шины I2C реализованы только путем переключения портов ATmega к \(0~V\).

\begin{table}[H]
  \begin{center}
    \begin{tabular}{| c || c | c | c | c |}
    \hline
      Порт & Символьный & Графический LCD & Графический LCD & Дополнительные\\
	   &     LCD    & SPI 4-wire &   I2C      &  функции \\
    \hline
    \hline
    PB2    &  LCD-RS         &            &          &       \\
    \hline                                              
    PB3    &  LCD-E          &            &  LCD-SCL &       \\
    \hline                                              
    PB4    &  LCD-D4         &  LCD-REST  &  LCD-SDA &       \\
    \hline                                              
    PB5    &  LCD-D5         &  LCD-RS    &          & ISP-MOSI \\
           &                 &            &          & поворотный энкодер 2 \\
    \hline                                              
    PB6    &  LCD-D6         &  LCD-SCLK  &          & ISP-MISO \\
    \hline                                            
    PB7    &  LCD-D7         &  LCD-SI    &          & ISP-SCK  \\
           &                 &            &          & поворотный энкодер 1 \\
    \hline
    \end{tabular}
  \end{center}
  \caption{Подключения дисплеев к портам ATmega324/644/1284}
  \label{tab:mega644-display}
\end{table}

\begin{figure}[H]
\centering
\includegraphics[width=18cm]{../FIG/t644tester.eps}
\caption{Расширенная схема Транзистор Тестера с ATmega644}
\label{fig:t644tester}
\end{figure}


\section{Программирование микроконтроллера}
Я публикую программное обеспечение для микроконтроллера ATmega с исходным кодом. Разработка сделана в среде 
операционной системы Linux (Ubuntu) и компилируется с помощью Makefile. Makefile даёт уверенность, что программное 
обеспечение будет корректно скомпилировано у Вас с предварительно выбранными опциями в Makefile. Некоторые структуры 
предкомпилированы с исходником. Пожалуйста, смотрите  ReadMe.txt файл в каталоге Software/default 
и главу~\ref{sec:config}.
Результат компиляции представлен файлами с двумя расширениями .hex и .eep. По умолчанию имена будут 
TransistorTester.hex и TransistorTester.eep. Файл с расширением .hex содержит данные для памяти программ (Flash), 
а файл с расширением .eep содержит данные для памяти EEprom  микроконтроллера ATmega. Оба файла с данными должны быть 
загружены в соответствующие области памяти микроконтроллера ATmega.\\

Дополнительные опции состояния микроконтроллера ATmega должны быть запрограммированы фьюзами.
Если Вы можете использовать мой Makefile с программой avrdude \cite{avrdude}, Вам не нужны детальные знания о фьюзах. 
Вы должны только выбрать «make fuses» , если у Вас нет кварца, или «make fuses-crystal» , если Вы установили кварц 
на \(8~MHz\) на свою печатную плату. С серией ATmega168 Вы можете также использовать, «make fuses-crystal-lp» , 
чтобы использовать кварц с низким потреблением мощности. Никогда не выбирайте установки с кварцем, если кварц 
на \(8~MHz\) у Вас не установлен. Если Вы не уверены с фьюзами, оставляете их заводскими и приведите Тестер в рабочее 
состояние в этом режиме. Работа программы может замедлиться, если Вы используете программные данные, определенные для 
работы на \(8~MHz\), но Вы сможете исправить это позже! А вот неправильный выбор фьюзов может запретить в будущем 
ISP-программирование. Конечно, программа avrdude должна поддерживать ваш программатор, и конфигурация в Makefile 
должна соответствовать Вашей среде разработки.\\ 

Если Вы используете операционную систему Windows, то самый легкий способ получить правильно запрограммированный ATmega 
состоит в том, чтобы использовать пакет WinAVR \cite{winavr1},\cite{winavr2}.
Для установки фьюзов с помощью Makefile Вы можете использовать мой Patch for WinAVR  \cite{winavr3}\\

На рисунке \ref{fig:WinAVR1} показано меню File графического интерфейса пользователя WinAVR для открытия файла 
Makefile (Open) и для того, чтобы сохранить изменённый Makefile (Save).

\begin{figure}[H]
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/Notepad_open.png}
    \caption{Открить Makefile}
  \end{subfigure}
  ~
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/Notepad_save.png}
    \caption{Сохранить Makefile}
  \end{subfigure}
  \caption{Использование программы WinAVR}
  \label{fig:WinAVR1}
\end{figure}

Следующий рисунок \ref{fig:WinAVR2} показывает меню Tools графического интерфейса пользователя WinAVR для того, чтобы 
скомпилировать программу (Make All) и для того, чтобы запрограммировать ATmega (Program) программой avrdude.

\begin{figure}[H]
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/Notepad_make.png}
    \caption{Создание прошивки (.hex/.eep)}
  \end{subfigure}
  ~
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/Notepad_program.png}
    \caption{Программирование ATmega}
  \end{subfigure}
  \caption{Использование WinAVR}
  \label{fig:WinAVR2}
\end{figure}



\section{Поиск неисправностей }
В большинстве случаев возникают проблемы с выводом текста на LCD-дисплей. Сначала Вы должны проверить, что светодиод 
LED1 не светится, если Вы отпускаете кнопку {\bf TEST}. 
\begin{description}

\item[Питание не включается.]
Если светодиод LED1 не светится, и VCC = \(5~V\) во время нажатия кнопки {\bf TEST}, микроконтроллер не включает 
питание. 
В первую очередь, микроконтроллер должен держать питание, переключая уровень PD6 на \(5~V\). Если Вы удерживаете кнопку 
{\bf TEST}, питание должно быть включено. Так Вы можете проверить величину напряжения питания VCC и одновременно величину 
напряжения на PD6. Если напряжения VCC = \(5~V\), а напряжение на PD6 ниже \(4~V\), то микроконтроллер не запускает программу. 
В этом случае Вы должны проверить, был ли микроконтроллер запрограммирован надлежащими данными для установленного у 
Вас типа ATmega во Flash и EEprom, и правильно ли сформированы фьюзы. Если микроконтроллер переводит состояние PD6 в 
\(5~V\), но питание не остается после отпускания кнопки {\bf TEST}, то это усложняет поиск причины. Сначала Вы можете замкнуть 
светодиод LED1 и попробовать еще раз. Если Тестер запускается, то светодиод LED1 может быть дефектным или установлен 
с неправильной полярностью. Если причина не эта, то недостаточен коэффициент усиления транзистора T3 (BC557C).

\item[Отсутствует текст на LCD-дисплее.]
Проверьте напряжение на контакте контрастности в LCD-дисплее. Установите значение, определенное в техническом описании. 
Отсутствующий текст на LCD-дисплее может быть вызван неправильным монтажом или выбором временных параметров. Если на 
LCD-дисплее нет никакой информации, а подсветка есть, то необходимо отключить питание и проверить четыре шины данных 
и две связи управляющих сигналов. Если всё нормально, единственной причиной, которую я вижу, является неправильный 
выбор временных параметров управляющих сигналов. Это может быть вызвано более медленным контроллером LCD-дисплея, чем 
заложено в программном обеспечении или работой программного обеспечения на неправильной тактовой частоте ATmega. 
Необходимо проверить, для какой тактовой частоты были скомпилированы программные данные, и соответствуют ли фьюзы, 
выбранной частоте ATmega. Вы найдёте параметр частоты в соответствующей строке Makefile. Если Тестер собран без 
отключения, Вы можете проверить работу программы с помощью светодиода, подключенного к испытательным выводам. 
Если светодиод мигает, то программа работает правильно.


\item[Что-то, но не все читаемое на LCD-дисплее.]
Проверить, правильные ли .eep данные загружены в память EEprom  ATmega. Если все данные загружены правильно, 
то необходимо проверить тактовую частоту, программные параметры данных (Makefile) и установки фьюзов ATmega.

\item[Медленное измерение и измеренная ёмкость в 8 раз меньше.] 
Программное обеспечение для \(8~MHz\), а работает ATmega на \(1~MHz\). Проверьте правильность установки фьюзов.

\item[Странные значения измерений.]
Для того, чтобы проводить измерения, ISP программатор должен быть отсоединен. Очень часто причина неправильных 
измерений - использование программного обеспечения, скомпилированного с опцией AUTOSCALE\_ADC и с опцией NO\_REF CAP, 
а на выводе AREF конденсатор ёмкостью \(100~nF\). Неправильный монтаж или остатки флюса также могут нарушить 
измерение. Пожалуйста, если возможно, проверьте функцией самопроверки программное обеспечение Тестера. Подробности 
смотрите в Главе \ref{sec:selftest}

Осмотрите свою плату визуально и проверьте величины резисторов омметром. Для этой проверки Вы можете использовать 
выводы ATmega, например, чтобы проверить R1, Вы можете провести измерения между выводами 23 и 14 ATmega. Смотрите 
схему на рисунке \ref{fig:ttester} Удалять микроконтроллер не обязательно, достаточно только отключить батарею 
или электропитание.

\item[Тестер выключает питание после 2 секунд отображения на дисплее.] 
Это может произойти, если отсутствует внешний подтягивающий резистор с порта PD7 к VCC, или кнопка {\bf TEST} 
удерживается нажатой. Программное включение внутренних подтягивающих резисторов влияет на результаты измерения, 
по этому необходим внешний подтягивающий резистор \(27~k\Omega\). 

\item[Тестер отображает только Vext=xx.xV во второй строке]
Эта проблема появляется, если подтягивающий резистор на выводе PD7
отсутствует, неисправен или кнопка {\bf TEST} удерживается в нажатом положении,
а программное обеспечение сконфигурировано с отключением UART (опция WITH\_UART отключена)
и отключенным внутренним подтягивающим резистором (с опцией PULLUP\_DISABLE). 
Необходима установка подтягивающего резистора на выводе PD7.

\end{description}
