\chapter{Конфигурирование Тестера}
\label{sec:config}
Пакет программного обеспечения для Тестера доступен с исходными кодами. Компиляцией модулей управляют с помощью 
Makefile. Разработка была сделана в операционной системе Linux Ubuntu с GNU toolchain (gcc версия 4.5.3). Можно 
использовать и другие операционные системы, например, Windows. Чтобы загрузить скомпилированные данные во Flash 
память и память EEprom программой avrdude (версия 5.11svn) загружают Makefile и указывают «make upload». Программа 
avrdude \cite{avrdude} доступна для операционных систем Linux и Windows. C-компилятор GNU gcc также поддерживается 
программным обеспечением AVR Studio и WinAVR \cite{winavr1},\cite{winavr2} в операционной системе Windows. Вы можете 
запрограммировать ATmega данными (.hex и.eep) также и другими инструментами, но только моя версия Makefile 
автоматически загрузит правильные данные в выбранный микроконтроллер. Avrdude загружает данные в ATmega, если 
Signature Bytes, подключённого ATmega, идентичны выбранному. Если Вы измените Makefile, то все программное 
обеспечение нужно будет скомпилировать вновь, указав команду «make» или «make upload». Программное обеспечение, 
скомпилированное для ATmega8, не работает на ATmega168. Программное обеспечение, скомпилированное для ATmega328, 
не работает на ATmega168! Исключением из этого правила является программное обеспечение, скомпилированное для 
ATmega168, эти данные могут также использоваться для ATmega328 без изменений. Будьте внимательны, если Вы не 
используете мой Makefile.\\ 

При правильном выборе установок, мое программное обеспечение запускается на недоработанных аппаратных средствах 
от Markus F.

(PARTNO=M8, NO\_AREF\_CAP - НЕТ и PULLUP\_DISABLE - НЕТ). Тактовая частота может также быть установлена \(8~MHz\) 
с фьюзами, указывающими, что кварц не требуется!\\ 

Для конфигурирования программного обеспечение Вашего Тестера доступны следующие опции, определенные в Makefile.


\begin{description}
  \item[PARTNO] Описывает целевой микроконтроллер:\\
         m8 = ATmega8\\
         m168 or m168p = ATmega168\\
         m328 or m328p = ATmega328\\
    Пример:  PARTNO = m168
  \item[UI\_LANGUAGE] Определяет выбранный язык\\
    LANG\_ENGLISH, LANG\_GERMAN, LANG\_POLISH, LANG\_CZECH, LANG\_SLOVAK, LANG\_SLOVENE, LANG\_DUTCH, LANG\_BRASIL,
 LANG\_RUSSIAN, LANG\_UKRAI-NIAN и LANG\_LITHUANIAN.
 Русский или украинский яык требует LCD-дисплей с кириллической кодировкой.\\
    Пример:  UI\_LANGUAGE = LANG\_ENGLISH
  \item[LCD\_CYRILLIC] Необходима только для LCD-дисплея с кириллической кодировкой. Символы \(\mu\) и \(\Omega\) 
отсутствуют в кириллической кодировке. Если Вы выбрали эту опцию, то оба символа отображаются на LCD-дисплее 
программно.\\
Пример: CFLAGS += -DLCD\_CYRILLIC
  \item[LCD\_DOGM] Должна быть установлена, если применяется LCD-дисплей с контроллером ST7036 (тип DOG-M). 
Контрастность LCD-дисплея устанавливают командами программного обеспечения.\\
Пример: CFLAGS += -DLCD\_DOGM
 \item[FOUR\_LINE\_LCD] Предусматривает установку символьного 4x20 LCD для более детального отображения дополнительной
информации.\\
Пример: CFLAGS += -DFOUR\_LINE\_LCD
  \item[WITH\_LCD\_ST7665] Эта опция должна устанавливатся при использовании графического 128x64 точек LCD с 
контроллером ST7665, который подключен по последовательному интерфейсу. Вместе с этой опцией должны быть выбраны
дополнительные опции, описанные ниже.\\ 
Пример: WITH\_LCD\_ST7565 = 1 
  \item[LCD\_ST7565\_RESISTOR\_RATIO] Этой опцией выбирается соотношение резисторов, которые используются в
делителе регулятора напряжения контроллера ST7565.
На практике, обычно, эти значения от 4 до 7.
Возможна установка значений от 0 до 7.\\
Пример: LCD\_ST7564\_RESISTOR\_RATIO = 4
  \item[WITH\_LCD\_ST7565\_HV\_FLIP] Эта опция позволяет перевернуть изображение, выводимое на LCD как по
горизонтали так и по вертикали.\\
Пример: WITH\_LCD\_ST7565\_HV\_FLIP = 1
  \item[FONT\_6X8] Вы должны выбрать размер шрифта контроллера ST7565.
Доступны размеры: FONT\_6X8, FONT\_8X8, FONT\_8X12, FONT\_8X14 и FONT\_16X16.
В настоящее время только размер 6х8 шрифта полностью поддерживается.\\
Пример: FONT\_6X8
  \item[STRIP\_GRID\_BOARD] Эта опция приспосабливает программное обеспечение к измененным назначениям выводов порта 
D на печатной плате. Вы можете найти подробности в аппаратных средствах главы \ref{sec:hardware}.\\
Пример: CFLAGS += -DSTRIP\_GRID\_BOARD
  \item[WITH\_MENU] активируется меню выбора функций для ATmega328. Вы сможете выбрать некоторые дополнительные 
функции работы прибора из меню при длительном (\textgreater~\(0.5~s\)) нажатии кнопки {\bf TEST}.\\
Пример: CFLAGS += -DWITH\_MENU
  \item[WITH\_SELFTEST] Если Вы выбираете эту опцию, программное обеспечение будет включать функцию самопроверки. 
Самопроверка будет начата, если Вы соедините все 3 испытательных порта вместе «закороткой» и начнете измерение, 
нажав кнопку {\bf TEST}.
Если функция выбрана, запускается только калибровка. Самодиагностика T1 - T7 возможна только при выборе функции
из дополнительного меню.\\
Пример: CFLAGS += -DWITH\_SELFTEST
  \item[NO\_COMMON\_COLLECTOR\_HFE] Эта опция отключает метод измерения hFE транзисторов по схеме с общим 
коллектором. По умолчанию включены оба метода для измерения hFE, но в памяти программ микроконтроллера ATmega168 
не хватает места для функций самопроверки. С помощью этой опции Вы можете сохранить память микроконтроллера 
ATmega168 для функций самопроверки T1-T7.\\
Пример: CFLAGS += -DNO\_COMMON\_COLLECTOR\_HFE
  \item[NO\_COMMON\_EMITTER\_HFE] Эта опция отключает метод измерения hFE транзисторов по схеме с общим эмиттером. 
По умолчанию включены оба метода для измерения hFE, но в памяти программ микроконтроллера ATmega168 не хватает 
места для функций самопроверки. С помощью этой опции Вы можете сохранить память микроконтроллера ATmega168 для 
функций самопроверки T1-T7.\\
Пример: CFLAGS += -DNO\_COMMON\_EMITTER\_HFE
  \item[NO\_TEST\_T1\_T7] Эта опция отключает выполнение функций самопроверки Т1 - Т7.
Эти тесты самопроверки полезны для обнаружения ошибок в аппаратных средствах, например, неправильного измерения 
сопротивлений или проблемы с изоляцией. Если Вы уверены, что оборудование исправно, то для ускорения калибровки 
Вы можете пропустить самопроверку Т1 - Т7, установив эту опцию. 
При включенной опции тесты Т1 - Т7 самодиагностики запускаются только из дополнительного меню «Selftest». 
Если с микроконтроллером ATmega168 используются оба метода измерения hFE, то функции самопроверки T1 - T7 
пропускается автоматически.\\
Пример: CFLAGS += -DNO\_TEST\_T1\_T7
  \item[AUTO\_CAL] В процедуре самопроверки будет дополнительно измерено смещение нуля при измерении ёмкости. 
Дополнительно будут измерены смещение аналогового компаратора (REF\_C\_KORR) и напряжение смещения внутреннего 
опорного напряжения (REF\_R\_ KORR), если Вы подключите качественный конденсатор с величиной ёмкости от \(100~nF\) 
до \(20~\mu F\) к выводам испытательных портов~1 и~3 после измерения смещения нуля при измерении ёмкости. Все 
найденные величины будут записаны в EEprom и будут использоваться для дальнейших измерений автоматически. Значения 
выходного сопротивления порта будут определяться в начале каждого измерения.\\
Пример: CFLAGS += -DAUTO\_CAL
  \item[FREQUENCY\_50HZ] Сигнал 50 Гц будет генерироваться на выводах испытательных портов~2 и~3 в течение максимум 
одной минуты в конце самопроверки.\\
Пример: CFLAGS += -DFREQUENCY\_50HZ
  \item[CAP\_EMPTY\_LEVEL] Эта опция  определяет уровень напряжения для разряженного конденсатора (в \(mV\)). Вы можете 
установить значение уровня выше \(3~mV\), если Тестер не успевает разряжать конденсатор. Это происходит в случае, если 
Тестер заканчивает измерение за более длительное время с сообщением «Cell!».\\
Пример: CFLAGS += -DCAP\_EMPTY\_LEVEL=3
  \item[WITH\_AUTO\_REF] Определяет такое опорное напряжение, которое позволяет получить фактический масштаб, для 
возможности измерения малых величин ёмкостей (ниже \(40~\mu F\)).\\
Пример:  CFLAGS += -DWITH\_AUTO\_REF
  \item[REF\_C\_KORR]Определяет смещение для опорного напряжения в \(mV\). Эта опция применяется для подстройки ёмкости 
при измерении небольших ёмкостей конденсаторов. Величина коррекции 10 пунктов понижает результат измерения 
приблизительно на 1\%. Если опция AUTO\_CAL выбирается вместе с опциями WITH\_SELFTEST, REF\_C\_KORR то эта величина 
будет смещением к разнице измеренного напряжения тестируемого конденсатора и внутреннего опорного напряжения.\\
Пример:  CFLAGS += -DREF\_C\_KORR=14
  \item[REF\_L\_KORR] Определяет дополнительное смещение в mV к опорному напряжению для измерения величины 
индуктивности. Смещение REF\_L\_KORR и соответствующая величина смещения при калибровке будет дополнительно 
использоваться при измерении индуктивности. Значение REF\_L\_KORR будет вычтено для измерения без 
резистора \(680~\Omega\) для измерения  с  резистором \(680~\Omega\), значение будет добавлено.\\
Пример: CFLAGS += -DREF\_L\_KORR=40
  \item[C\_H\_KORR] Определяет величину коррекции при измерении больших ёмкостей. Величина коррекции 10 пунктов 
понижает результат измерения на 1\%. \\
Пример:  CFLAGS += -DC\_H\_KORR=10
  \item[WITH\_UART] Использует порт PC3 для последовательного вывода данных (протокол V24). Если опция не выбрана, 
порт PC3 может использоваться для измерения внешнего напряжения  с делителем 10:1. С дополнительной схемой Вы 
можете проверить напряжение пробоя стабилитронов, большее, чем \(4.5~V\). Это измерение повторяется с периодом 3 раза 
в секунду, пока Вы не отпустите кнопку {\bf TEST}.\\
Пример: CFLAGS += -DWITH\_UART
  \item[TQFP\_ADC6] Опция TQFP\_ADC6 определяет возможность использования аналогового входа ADC6 ATmega в корпусе TQFP или QFN
вместо ADC3 (PC3).
С этой опцией возможно измерение внешнего напряжения, независимо от использования PC3 в качестве UART.
ADC6 вход используется для измерения стабилитронов или внешних напряжений в зависимости от выбора из диалогового меню
в ATmega328.\\
Пример: CFLAGS += -DTQFP\_ADC6
  \item[TQFP\_ADC7] Опция TQFP\_ADC7 определяет возможность использования аналогового входа ADC7 ATmega в корпусе TQFP или QFN
вместо PC3 (ADC3).
С этой опцией возможно измерение внешнего напряжения, независимо от использования PC3 в качестве UART.
Если эта опция используется без опции TQFP\_ADC6, то измерение стабилитронов и внешнего напряжения производится 
с использованием входного аналогового порта ADC7 при выборе из дополнительного меню в ATmega328. Если опция
установлена совместно с TQFP\_ADC6, то измерение стабилитронов доступно на ADC6, а внешних 
напряжений на обеих портах в зависимости от выбора из дополнительного меню ATmega328. 
Оба входные порты ADC должны быть оборудованы резистивным делителями 10:1.\\
Пример: CFLAGS += -DTQFP\_ADC7
  \item[AUTOSCALE\_ADC] Позволяет автоматически переключать масштаб АЦП или к VCC или к внутреннему ИОН. Внутренний 
ИОН \(2.56~V\) для ATmega8 и \(1.1~V\) для остальных микроконтроллеров ATmega.\\
Пример: CFLAGS += -DAUTOSCALE\_ADC
  \item[ESR\_ZERO]Определяет смещение нуля при измерении ESR. Смещение нуля для всех трех комбинаций испытательных 
выводов определяется в режиме самопроверки и заменяет предустановленное смещение нуля. Эта величина будет вычтена 
из всех измерений ESR.\\
Пример: CFLAGS += -DESR\_ZERO=29
  \item[NO\_AREF\_CAP] Сообщает программному обеспечению, что у Вас нет конденсатора (\(100~nF\)), установленного 
на выводе AREF (вывод 21). Это позволяет сократить задержку для AUTOSCALE\_ADC при переключении масштаба. 
Конденсатор на \(1~nF\) не вносит искажений в результаты измерений. На рисунке \ref{pic:aref1} и \ref{pic:aref5} 
показано время переключения  с конденсатором на \(1~nF\).
Вы можете видеть, что переключение от \(5~V\) до \(1.1~V\) намного медленнее, чем переключение назад, от \(1.1~V\) 
до \(5~V\). 
Если у Вас установлен конденсатор на \(100~nF\), время переключения будет дольше в 100 раз!\\
Пример: CFLAGS += -DNO\_AREF\_CAP
  \item[REF\_R\_KORR] Определяет смещение для внутреннего опорного напряжения АЦП в mV. Это смещение отклонения 
при переключении с основной опоры АЦП VCC на внутренний ИОН АЦП может быть использовано при измерении резистора. 
Если Вы выберете опцию AUTO\_CAL в режиме самопроверки, это значение будет дополнительным смещением к найденному 
напряжению отклонения в AUTO\_CAL.\\
Пример: CFLAGS += -DREF\_R\_KORR=10
  \item[OP\_MHZ] Сообщает программному обеспечению, на какой частоте в \(MHz\) будет функционировать Ваш Тестер. 
Программное обеспечение проверено только на \(1~MHz\), \(8~MHz\) и, дополнительно, на \(16~MHz\). \(8~MHz\) 
рекомендуется для лучшего разрешения при измерении ёмкости и индуктивности.\\
Пример: OP\_MHZ = 8
  \item[RESTART\_DELAY\_TICS] Если ATmega168 или ATmega328 используются с внутренним RC-генератором вместо кварца, 
то величина установки должна быть 6. Если это значение не установлено, то при перезапуске из SLEEP MODE ATmega с 
кварцем, программное обеспечение отсчитывает задержку 
в 16384 такта.\\
Пример: CFLAGS += -DRESTART\_DELAY\_TICS=6
  \item[USE\_EEPROM]Параметр указывает память EEprom для размещения фиксированного текста и таблиц. В противном 
случае используется программная память Flash. Рекомендуется использовать память EEprom (опция установлена).\\
Пример: CFLAGS += -DUSE\_EEPROM
\item[EBC\_STYLE] Определяет, что информация  расположения выводов транзистора отображается в формате «EBC=...» 
или «GDS=...».
Это положение выводов сохраняется в памяти программ ATmega. Без этой опции формат будет «123=...», где каждая 
точка обозначает символы: E~(Эмиттер), B~(База) и C~(Коллектор).
Для транзисторов FET каждая точка может быть G~(Затвор), D~(Сток) or S~(Исток).
Если последовательность выводов 1, 2 и 3 не в направлении чтения, то Вы можете инвертировать последовательность, 
выбрав EBC\_STYLE=321. Назначение выводов тогда будет «321 = ...», которое будет лучше соответствовать обычному 
чтению.\\
Пример: CFLAGS += EBC\_STYLE
  \item[NO\_NANO]Определяет, что десятичная приставка nano не будет использоваться при отображении измеренных 
результатов. Таким образом, значения отображаются в \(\mu F\) вместо \(nF\).\\
Пример: CFLAGS += NO\_NANO
\item[PULLUP\_DISABLE] Определяет, что Вы не нуждаетесь во внутренних подтягивающих резисторах. Если Вы выбрали 
эту опцию, то у Вас должен быть установлен внешний резистор с вывода PD7 (вывод~13) к VCC. Эта опция предотвращает 
возможное влияние  подтягивающих резисторов на результаты измерений в измерительных портах (порт~B и порт~C). \\
Пример: CFLAGS += -DPULLUP\_DISABLE
  \item[ANZ\_MESS] Эта опция определяет, как часто значение АЦП считано и суммировано. Вы можете выбрать любое 
значение между 5 и 200 для подсчета среднего значения одного  измерения АЦП. Более высокие значения дают большую 
точность, но удлиняют время измерения. Одно измерение АЦП со значением 44 требует приблизительно \(5~ms\).\\
Пример: CFLAGS += -DANZ\_MESS=25
  \item[POWER\_OFF] Эта опция включает функцию автоматического выключения питания. Если Вы не установите эту опцию, 
измерения будут идти бесконечно, пока питание не будет отключено переключателем Вкл/Выкл. Если у Вас Тестер без 
схемы отключения питания, то Вы можете не выбирать POWER\_OFF.
 
Если Вы не установили опцию POWER\_OFF с установленными транзисторами, то Тестер можно выключить из меню 
выбора функций если опция WITH\_MENU активирована.
 
Вы можете также определить, после скольких измерений без определения элемента Тестер выключится. Тестер также 
отключит питание после вдвое большего числа измерений, сделанных последовательно без неудавшегося поиска элемента. 
Это позволяет избежать полного разряда батареи, если Вы забыли отсоединять тестируемый элемент. Выбор определяется 
как CFLAGS += -DPOWER\_OFF=5 для 5 последовательных измерений без определения элемента. Тестер также выключится 
после 10 измерений с определением элемента. Если любая последовательность измерений будет прервана другим типом, 
то измерение продолжится. Результат измерения отображается на дисплее в течение 28 секунд для однократного 
измерения, для многократного измерения время отображения уменьшено до 5 секунд (выбор в config.h). Если кнопка 
{\bf TEST} нажата более длительное время, то время отображения для многократного измерения также 28~секунд. 
Максимальное значение 255 (CFLAGS += -DPOWER\_OFF=255).\\
Пример 1: CFLAGS += -DPOWER\_OFF=5\\
Пример 2: CFLAGS += -DPOWER\_OFF
  \item[BAT\_CHECK] Позволяет проверять напряжение батареи питания. Если Вы не выбираете эту опцию, то на  
LCD-дисплее вместо напряжения будет отображаться номер версии программного обеспечения. Эта опция полезна для 
версии Тестера, работающей от автономного источника питания, чтобы напомнить о разряде источника питания.\\
Пример: CFLAGS += -DBAT\_CHECK
  \item[BAT\_OUT] Позволяет отображать напряжение батареи на LCD-дисплее (если выбрана опция BAT\_CHECK). Если 
в цепи питания \(9~V\) установлен диод, то для правильного измерения выходного значения необходимо учесть напряжение, 
упавшее на нем (в \(mV\)), для этого используйте  BAT\_OUT =600. Также этой опцией можно учитывать падение напряжения 
на транзисторе T3. Пороговый уровень не влияет на уровни проверки напряжения (BAT\_POOR).\\
Пример 1: CFLAGS += -DBAT\_OUT=300\\
Пример 2: CFLAGS += -DBAT\_OUT
  \item[BAT\_POOR] Установка нижнего уровня напряжения батареи, задаваемые в \(mV\). 
Если нижний уровень составляет больше чем \(5.3~V\), то уровень предупреждения о разряде батареи на \(0.8~V\) выше, 
чем указанный нижний уровень. 
Если нижний уровень составляет \(5.3 V\) или менее, то уровень предупреждения о разряде батареи на \(0.4~V\) выше, 
чем указанный нижний уровень. 
Если нижний уровень ниже \(3.25~V\), то уровень предупреждения о разряде батареи на \(0.2~V\) выше, чем указанный 
нижний уровень. 
Если нижний уровень ниже \(1.3~V\), то уровень предупреждения о разряде батареи на \(0.1~V\) выше, чем указанный 
нижний уровень. 
Установка нижнего уровня \(5.4~V\) не рекомендуется для перезаряжаемых \(9~V\) аккумуляторов, потому что это 
увеличивает риск повреждения аккумулятора из-за глубокого разряда! Если Вы хотите использовать \(9~V\) аккумулятор, 
то рекомендуется использовать Ready To Use тип аккумулятора из-за более низкого саморазряда.\\
Пример для low drop regulator (\(5.4~V\)): CFLAGS += -DBAT\_POOR=5400\\
Пример для 7805 type regulator (\(6.4~V\)): CFLAGS += -DBAT\_POOR=6400
  \item[INHIBIT\_SLEEP\_MODE] Выключает использование SLEEP\_MODE микроконтроллера. Обычно программное обеспечение 
использует SLEEP\_MODE для более длительной работы. Использование этого способа действительно экономит заряд батареи, 
но создает дополнительную нагрузку для стабилизатора напряжения.\\
Пример: CFLAGS += -DINHIBIT\_SLEEP\_MODE

  \item[PROGRAMMER] Ваш тип программатора для программного интерфейса avrdude. Правильный выбор этой опции 
необходим, если Вы используете команду «make upload» или «make fuses» этого Makefile. За дополнительной 
информацией обратитесь, пожалуйста, к описанию avrdude и онлайн – документации ~\cite{avrdude}.\\
Пример: PROGRAMMER=avrisp2
  \item[BitClock] Выбирает частоту синхронизации для программатора. См. описание -B параметра для avrdude.\\
Пример: BitClock=5.0
  \item[PORT] Выбранный порт, через который Ваш микроконтроллер ATmega может быть доступным для avrdude. За 
дополнительной информацией обратитесь, пожалуйста, к описанию avrdude.\\
Пример: PORT=usb

\end{description}

\begin{figure}[H]
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/AREF2_1V.png}
    \caption{с \(5~V\) до \(1.1~V\)}
    \label{pic:aref1}
  \end{subfigure}
  ~
  \begin{subfigure}[b]{9cm}
    \centering
    \includegraphics[width=9cm]{../PNG/AREF2VCC.png}
    \caption{с \(1.1~V\) до \(5~V\)}
    \label{pic:aref5}
  \end{subfigure}
  \caption{Переключение AREF с ёмкостью \(1~nF\)}
\end{figure}


Дополнительные параметры могут быть установлены в файлах transistortester.h и config.h. Файл config.h  
содержит глобальные переменные и определяет порт/контакт и величину резистора, используемые для измерения. Файл 
transistortester.h определяет параметры для различных типов микроконтроллеров, задержку и частоту АЦП. Обычно нет 
необходимости изменять эти значения.
